<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="强化学习实践教学, 博客制作,个人经验分享,Unity,人工智能等">
    <meta name="description" content="本站记录本人各种学习的旅途，用于巩固自我并启发后来人">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>强化学习实践教学 | 微笑紫瞳星</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>



   <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">微笑紫瞳星</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">微笑紫瞳星</div>
        <div class="logo-desc">
            
            本站记录本人各种学习的旅途，用于巩固自我并启发后来人
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">强化学习实践教学</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">
                                <span class="chip bg-color">强化学习</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/" class="post-category">
                                强化学习
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-16
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-02
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    52 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p> 参考视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yv411i7xd">https://www.bilibili.com/video/BV1yv411i7xd</a> </p>
<p>代码下载：<a target="_blank" rel="noopener" href="https://github.com/PaddlePaddle/PARL">https://github.com/PaddlePaddle/PARL</a></p>
<p>可以先阅读我的文章《强化学习概述》，重复的内容不再叙述。代码主要参考强化学习算法框架库：PARL</p>
<h2 id="资料推荐"><a href="#资料推荐" class="headerlink" title="资料推荐"></a>资料推荐</h2><ul>
<li><p>书籍：《Reinforcement Learning: An Introduction》</p>
</li>
<li><p>视频：David Silver经典强化学习公开课、UC Berkeley CS285、斯坦福CS234</p>
</li>
<li><p>经典论文：</p>
<ul>
<li><p>DQN：<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1312.5602.pdf">https://arxiv.org/pdf/1312.5602.pdf</a></p>
</li>
<li><p>A3C: <a target="_blank" rel="noopener" href="https://www.jmlr.org/proceedings/papers/v48/mniha16.pdf">https://www.jmlr.org/proceedings/papers/v48/mniha16.pdf</a></p>
</li>
<li><p>DDPG: <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1509.02971">https://arxiv.org/pdf/1509.02971</a></p>
</li>
<li><p>PPO: <a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1707.06347">https://arxiv.org/pdf/1707.06347</a></p>
</li>
</ul>
</li>
</ul>
<ul>
<li>前沿研究方向：Model-base RL、Hierarchical RL、Multi Agent RL、Meta Learning。</li>
</ul>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/1.png" class>



<h2 id="序章"><a href="#序章" class="headerlink" title="序章"></a>序章</h2><h3 id="Agent学习的两种方案"><a href="#Agent学习的两种方案" class="headerlink" title="Agent学习的两种方案"></a>Agent学习的两种方案</h3><p>一种是基于价值（value-based），一种是基于策略（policy-based）</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/2.png" class>

<p>基于价值：我们给每一个状态都赋予一个“价值”的概念，例如上图C状态的价值大于A状态，也就是往C走离奖励更近。我们的做法是让Agent总是往价值高的地方移动，这样就能找出一个最优的策略。一旦函数优化到最优了，相同的输入永远是同一个输出。</p>
<p>代表方法：Sarsa、Q-learning、DQN。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/3.png" class>

<p>基于策略：我们直接让一条策略走到底，然后用最后的reward来判断策略是好是坏。好的策略能在以后的行为中获得更高的触发几率。由于输出的是几率，因此同样的输入会获得不同的输出，随机性更强。</p>
<p>代表方法：Policy Gradient。</p>
<h3 id="RL概览分类"><a href="#RL概览分类" class="headerlink" title="RL概览分类"></a>RL概览分类</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/4.png" class>

<p>强化学习分为无模型（model-free）和基于模型（model-based），无模型的研究会更加热门，上面的两种方案都是无模型的分类。</p>
<p>Model-free: 不需要知道状态之间的转移概率（transition probability）。</p>
<p>Model-based: 需要知道状态之间的转移概率。</p>
<p>而在Model-free中又有三种分类：</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/60.png" class>





<h3 id="算法库"><a href="#算法库" class="headerlink" title="算法库"></a>算法库</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/5.png" class>

<p>这里我们使用强化学习算法框架库：PARL。这里涵盖了很多的经典算法，又能复现一些最新的流行算法。看代码的学习方式，也是最快上手的学习方式。直接扫左上角二维码来学习。其中多智能体是一个热门的研究方向，被认为更接近人类社会的交互形式。</p>
<h3 id="RL编程实践：GYM"><a href="#RL编程实践：GYM" class="headerlink" title="RL编程实践：GYM"></a>RL编程实践：GYM</h3><p>前面的是和算法相关的库。另外一类是和环境相关的库。GYM是学术界比较喜欢的环境库。环境分为离散控制场景和连续控制场景，离散控制是输出只有有限个量，例如控制方向时只有向左向右，一般使用atari环境评估。连续控制是输出是一个连续的量，例如机械臂旋转的角度，一般使用mujoco环境来评估。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/6.png" class>



<h3 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h3><p>在安装了python环境的前提下，打开cmd，输入以下命令：</p>
<pre class=" language-cmd"><code class="language-cmd">pip install paddlepaddle==1.6.3 # 网络超时加上-i https://pypi.tuna.tsinghua.edu.cn/simple，安装GPU版本要用paddlepaddle-gpu
pip install parl==1.3.1     #如果安装不成功，在install后加上--user
pip install gym</code></pre>
<h3 id="程序示例（失败）及PARL的优势"><a href="#程序示例（失败）及PARL的优势" class="headerlink" title="程序示例（失败）及PARL的优势"></a>程序示例（失败）及PARL的优势</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/7.png" class>

<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> gym
<span class="token keyword">from</span> gridworld <span class="token keyword">import</span> CliffWalkingWapper
<span class="token keyword">import</span> turtle

<span class="token comment" spellcheck="true"># 创建环境</span>
env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">"CliffWalking-v0"</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 绘制一个图形界面，不写这一行只有文字界面</span>
env <span class="token operator">=</span> CliffWalkingWapper<span class="token punctuation">(</span>env<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 重置界面，开始新的一轮</span>
env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 展示界面</span>
env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 跟环境交互一步，如果有返回值第一个是纵坐标，第二个是reward，第三个是一轮是否结束</span>
<span class="token comment" spellcheck="true"># step(1)是往右走，step(2)是往下走，step(3)是向左走</span>
env<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 让程序运行结束后界面不立刻关闭</span>
turtle<span class="token punctuation">.</span>exitonclick<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>PARL对框架库做了很好的抽象，所有的算法几乎都集中于Model，Algorithm，Agent三个类。其中Algoritm已经实现了核心的部分，另外两部分开发者可以很方便实现订制。在上面下载的PARL中，有许多算法的Example。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/8.png" class>

<p>从上面随便找一个example，然后<strong>对model和Agent文件做一定修改，就可以移植到新的应用场景中。</strong></p>
<p>PARL的工业应用能力很强。只需要加两行代码，就可以把单机训练变成多机训练。PARL的并行能力很强，和Python不同，真正做到多线程运行，节省大量时间</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/9.png" class>

<p>配置好环境后，直接运行QuickStart里面的程序，看看是否成功，此处本人没有运行成功，报错信息如下：</p>
<pre><code>C:\Python39\lib\site-packages\parl\remote\communication.py:38: FutureWarning: 'pyarrow.default_serialization_context' is deprecated as of 2.0.0 and will be removed in a future version. Use pickle or the pyarrow IPC functionality instead.
  context = pyarrow.default_serialization_context()
W0718 17:57:30.795331  4240 device_context.cc:404] Please NOTE: device: 0, GPU Compute Capability: 6.1, Driver API Version: 11.1, Runtime API Version: 10.2
[07-18 17:57:30 MainThread @train.py:73] obs_dim 4, act_dim 2
W0718 17:57:30.798295  4240 dynamic_loader.cc:238] Note: [Recommend] copy cudnn into CUDA installation directory. 
 For instance, download cudnn-10.0-windows10-x64-v7.6.5.32.zip from NVIDIA's official website, 
then, unzip it and copy it into C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v10.0
You should do this according to your CUDA installation directory and CUDNN version.</code></pre>
<p>安装CUDNN依旧测试失败，如果有人知道缘由，请私聊。</p>
<h2 id="基于表格型方法求解RL"><a href="#基于表格型方法求解RL" class="headerlink" title="基于表格型方法求解RL"></a>基于表格型方法求解RL</h2><h3 id="强化学习MDP四元组"><a href="#强化学习MDP四元组" class="headerlink" title="强化学习MDP四元组"></a>强化学习MDP四元组</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/10.png" class>

<p>这就是强化学习MDP四元组。我们用状态转移概率表述：在$s_t$状态选择$a_t$的动作转移到$s_{t+1}$而且拿到奖励$r_t$的概率。这样的决策过程是马尔科夫决策过程（MDP）。这是一个序列决策的经典表达方式。</p>
<h3 id="状态转移和序列决策"><a href="#状态转移和序列决策" class="headerlink" title="状态转移和序列决策"></a>状态转移和序列决策</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/11.png" class>

<p>每次我们只能走其中的一条完整通路，这就是一个观察状态和执行决策不断循环的过程。每次我们都用两个函数描述环境。一个是Probability Function（P函数）,反映了环境的随机性。一个状态如果必然转移到下一个特定的状态，那么状态转移概率是100%。如果有多种可能的情况，每个的状态转移概率在0到100%之间。和状态转移概率成对的是Reward Function（R函数），描述了环境的好坏。P函数和R函数已知，则称这个环境已知，也称为<strong>Model-based</strong>。<strong>如果这些条件已知，那么我们就可以用动态规划来寻找最优策略。</strong>但这里我们不讲动态规划。</p>
<p>这里我们针对的是在环境未知的情况下的解决方法，因为在实际问题中的状态转移概率往往是未知的。对于P函数和R函数未知的状况我们称为<strong>Model-free</strong>。</p>
<h3 id="Q表格"><a href="#Q表格" class="headerlink" title="Q表格"></a>Q表格</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/12.png" class>

<p>Q表格指导每一个Step的动作选择，目标导向是<strong>未来的总收益</strong>。由于收益往往具有延迟，因此未来的总收益才能代表当前动作选择的价值。但是由于前面的动作对越往后的状态影响越小，因此我们需要引入衰减因子。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/13.png" class>

<p><strong>强化的概念是我们可以用下一个状态的价值更新现在状态的价值。</strong>因此我们每一个Step都可以更新Q表格，这是一种时序差分的更新方法。</p>
<h3 id="时序差分（Temporal-Difference）"><a href="#时序差分（Temporal-Difference）" class="headerlink" title="时序差分（Temporal Difference）"></a>时序差分（Temporal Difference）</h3><p>推荐一个有意思的网站：<a target="_blank" rel="noopener" href="https://cs.stanford.edu/people/karpathy/reinforcejs/gridworld_td.html">https://cs.stanford.edu/people/karpathy/reinforcejs/gridworld_td.html</a></p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/14.png" class>

<p>只有一个格子的reward为1，有很多格子reward为-1，随着小球的探索，有价值的格子也会把周围格子的分数拉高，形成一个整体的“评分体系”。只需要沿着分数增加的方向走一定能找到reward为1的点。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/15.png" class>

<p><strong>这就是一种时序差分的更新方法。</strong></p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/16.png" class>

<p>我们要让$Q(S_t,A_t)$逐步逼近理想的值，因此我们每次只更新一点点，α就是更新的速率。通过不断的更新我们可以让每一个状态的$G_t$都满足：<br>$$<br>G_t  = R_{t+1} + \gamma G_{t+1}<br>$$<br>这就是<strong>Sarsa算法</strong>，命名方式是按照这五个值来进行计算。上面的格子的价值更新就是按照上面的公式来的。</p>
<h3 id="Sarsa算法代码解析"><a href="#Sarsa算法代码解析" class="headerlink" title="Sarsa算法代码解析"></a>Sarsa算法代码解析</h3><p>Agent最重要的是实现两个功能，一个是根据算法选Action，第二个是学习Q表格。并且每一个step都包含这两步。</p>
<p>我们要另开一个agent.py文件，声明一个Agent类，Sample函数选择要输出Action，learn函数来更新Q。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">SarsaAgent</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>obs_n<span class="token punctuation">,</span>act_n<span class="token punctuation">,</span>learning_rate<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span>gamma<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>e_greed<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>act_n <span class="token operator">=</span> act_n  <span class="token comment" spellcheck="true"># 动作维度，有几个动作可选</span>
        self<span class="token punctuation">.</span>lr <span class="token operator">=</span> learning_rate  <span class="token comment" spellcheck="true"># 学习率</span>
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma  <span class="token comment" spellcheck="true"># reward的衰减率</span>
        self<span class="token punctuation">.</span>epsilon <span class="token operator">=</span> e_greed  <span class="token comment" spellcheck="true"># 按一定概率随机选动作</span>
        self<span class="token punctuation">.</span>Q <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>obs_n<span class="token punctuation">,</span> act_n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#生成一个矩阵作为Q表格,参数分别是状态的维度和动作维度，有多少格子就有多少状态</span>

    <span class="token comment" spellcheck="true"># 根据输入观察值，返回输出的Action对应的索引，带探索</span>
    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>epsilon<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#根据table的Q值选动作</span>
            action <span class="token operator">=</span> self<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>self<span class="token punctuation">.</span>act_n<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#有一定概率随机探索选取一个动作</span>
        <span class="token keyword">return</span> action

    <span class="token comment" spellcheck="true"># 根据输入观察值，输出分数最高的一个动作值</span>
    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        Q_list <span class="token operator">=</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
        maxQ <span class="token operator">=</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>Q_list<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">#where函数返回一个包含数组和数据类型的元组，取第一个才是数组</span>
        action_list <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>Q_list <span class="token operator">==</span> maxQ<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># maxQ可能对应多个action</span>
        action <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>action_list<span class="token punctuation">)</span>
        <span class="token keyword">return</span> action

    <span class="token comment" spellcheck="true"># 学习方法，也就是更新Q-table的方法，采用Sarsa算法来更新Q表格</span>
    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> next_action<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" on-policy
            obs: 交互前的obs, s_t
            action: 本次交互选择的action, a_t
            reward: 本次动作获得的奖励r
            next_obs: 本次交互后的obs, s_t+1
            next_action: 根据当前Q表格, 针对next_obs会选择的动作, a_t+1
            done: episode是否结束
        """</span>
        predict_Q <span class="token operator">=</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">]</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            target_Q <span class="token operator">=</span> reward  <span class="token comment" spellcheck="true"># 没有下一个状态了</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            target_Q <span class="token operator">=</span> reward <span class="token operator">+</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>next_obs<span class="token punctuation">,</span>
                                                    next_action<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># Sarsa</span>
        self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>lr <span class="token operator">*</span> <span class="token punctuation">(</span>target_Q <span class="token operator">-</span> predict_Q<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 修正q</span>

    <span class="token comment" spellcheck="true"># 保存Q表格</span>
    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        npy_file <span class="token operator">=</span> <span class="token string">'./q_table.npy'</span>
        np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>npy_file<span class="token punctuation">,</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>npy_file <span class="token operator">+</span> <span class="token string">' saved.'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 读取Q表格</span>
    <span class="token keyword">def</span> <span class="token function">restore</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> npy_file<span class="token operator">=</span><span class="token string">'./q_table.npy'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>Q <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>npy_file<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>npy_file <span class="token operator">+</span> <span class="token string">' loaded.'</span><span class="token punctuation">)</span></code></pre>
<p>然后再开一个文件写我们的main函数：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> gym
<span class="token keyword">from</span> gridworld <span class="token keyword">import</span> CliffWalkingWapper<span class="token punctuation">,</span> FrozenLakeWapper
<span class="token keyword">from</span> agent <span class="token keyword">import</span> SarsaAgent
<span class="token keyword">import</span> time


<span class="token keyword">def</span> <span class="token function">run_episode</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    total_steps <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment" spellcheck="true"># 记录每个episode走了多少step</span>
    total_reward <span class="token operator">=</span> <span class="token number">0</span>

    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 重置环境, 重新开一局（即开始新的一个episode）</span>
    action <span class="token operator">=</span> agent<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 根据算法选择一个动作</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        next_obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 执行动作,action在0~3代表不同方向，并返回下一个状态</span>
        next_action <span class="token operator">=</span> agent<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>next_obs<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 根据算法选择下一个动作</span>
        <span class="token comment" spellcheck="true"># 训练 Sarsa 算法，更新Q表格</span>
        agent<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> next_action<span class="token punctuation">,</span> done<span class="token punctuation">)</span>

        action <span class="token operator">=</span> next_action <span class="token comment" spellcheck="true"># 把下一个动作更新为现在的动作</span>
        obs <span class="token operator">=</span> next_obs  <span class="token comment" spellcheck="true"># 把下一个状态更新为现在的状态</span>
        total_reward <span class="token operator">+=</span> reward
        total_steps <span class="token operator">+=</span> <span class="token number">1</span>  <span class="token comment" spellcheck="true"># 计算step数</span>
        <span class="token keyword">if</span> render<span class="token punctuation">:</span>
            env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#渲染新的一帧图形</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> total_reward<span class="token punctuation">,</span> total_steps

<span class="token comment" spellcheck="true"># 测试函数</span>
<span class="token keyword">def</span> <span class="token function">test_episode</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    total_reward <span class="token operator">=</span> <span class="token number">0</span>
    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        action <span class="token operator">=</span> agent<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># greedy</span>
        next_obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        total_reward <span class="token operator">+=</span> reward
        obs <span class="token operator">=</span> next_obs
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
        env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'test reward = %.1f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>total_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># env = gym.make("FrozenLake-v0", is_slippery=False)  # 0 left, 1 down, 2 right, 3 up</span>
    <span class="token comment" spellcheck="true"># env = FrozenLakeWapper(env)</span>

    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">"CliffWalking-v0"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 0 up, 1 right, 2 down, 3 left</span>
    <span class="token comment" spellcheck="true"># 创建一个图形界面</span>
    env <span class="token operator">=</span> CliffWalkingWapper<span class="token punctuation">(</span>env<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 实例化agent</span>
    agent <span class="token operator">=</span> SarsaAgent<span class="token punctuation">(</span>
        obs_n<span class="token operator">=</span>env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>n<span class="token punctuation">,</span>
        act_n<span class="token operator">=</span>env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n<span class="token punctuation">,</span>
        learning_rate<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
        gamma<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span>
        e_greed<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>

    is_render <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">for</span> episode <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ep_reward<span class="token punctuation">,</span> ep_steps <span class="token operator">=</span> run_episode<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> is_render<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Episode %s: steps = %s , reward = %.1f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>episode<span class="token punctuation">,</span> ep_steps<span class="token punctuation">,</span>
                                                          ep_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># 每隔20个episode渲染一下看看效果</span>
        <span class="token keyword">if</span> episode <span class="token operator">%</span> <span class="token number">20</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            is_render <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            is_render <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token comment" spellcheck="true"># 训练结束，查看算法效果</span>
    test_episode<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>生成图形环境的文件gridworld.py的代码如下：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> gym
<span class="token keyword">import</span> turtle
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token comment" spellcheck="true"># turtle tutorial : https://docs.python.org/3.3/library/turtle.html</span>


<span class="token keyword">def</span> <span class="token function">GridWorld</span><span class="token punctuation">(</span>gridmap<span class="token operator">=</span>None<span class="token punctuation">,</span> is_slippery<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> gridmap <span class="token keyword">is</span> None<span class="token punctuation">:</span>
        gridmap <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'SFFF'</span><span class="token punctuation">,</span> <span class="token string">'FHFH'</span><span class="token punctuation">,</span> <span class="token string">'FFFH'</span><span class="token punctuation">,</span> <span class="token string">'HFFG'</span><span class="token punctuation">]</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">"FrozenLake-v0"</span><span class="token punctuation">,</span> desc<span class="token operator">=</span>gridmap<span class="token punctuation">,</span> is_slippery<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    env <span class="token operator">=</span> FrozenLakeWapper<span class="token punctuation">(</span>env<span class="token punctuation">)</span>
    <span class="token keyword">return</span> env


<span class="token keyword">class</span> <span class="token class-name">FrozenLakeWapper</span><span class="token punctuation">(</span>gym<span class="token punctuation">.</span>Wrapper<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gym<span class="token punctuation">.</span>Wrapper<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> env<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>max_y <span class="token operator">=</span> env<span class="token punctuation">.</span>desc<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>max_x <span class="token operator">=</span> env<span class="token punctuation">.</span>desc<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>t <span class="token operator">=</span> None
        self<span class="token punctuation">.</span>unit <span class="token operator">=</span> <span class="token number">50</span>

    <span class="token keyword">def</span> <span class="token function">draw_box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> fillcolor<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> line_color<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>up<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>x <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">,</span> y <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>color<span class="token punctuation">(</span>line_color<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>fillcolor<span class="token punctuation">(</span>fillcolor<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>setheading<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>down<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>begin_fill<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>right<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>end_fill<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">move_player</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>up<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>setheading<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>fillcolor<span class="token punctuation">(</span><span class="token string">'red'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">,</span> <span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>t <span class="token operator">==</span> None<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>t <span class="token operator">=</span> turtle<span class="token punctuation">.</span>Turtle<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wn <span class="token operator">=</span> turtle<span class="token punctuation">.</span>Screen<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wn<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>self<span class="token punctuation">.</span>unit <span class="token operator">*</span> self<span class="token punctuation">.</span>max_x <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">,</span>
                          self<span class="token punctuation">.</span>unit <span class="token operator">*</span> self<span class="token punctuation">.</span>max_y <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wn<span class="token punctuation">.</span>setworldcoordinates<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>unit <span class="token operator">*</span> self<span class="token punctuation">.</span>max_x<span class="token punctuation">,</span>
                                        self<span class="token punctuation">.</span>unit <span class="token operator">*</span> self<span class="token punctuation">.</span>max_y<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>shape<span class="token punctuation">(</span><span class="token string">'circle'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>width<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>speed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>color<span class="token punctuation">(</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>self<span class="token punctuation">.</span>desc<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> j <span class="token keyword">in</span> range<span class="token punctuation">(</span>self<span class="token punctuation">.</span>desc<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    x <span class="token operator">=</span> j
                    y <span class="token operator">=</span> self<span class="token punctuation">.</span>max_y <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> b<span class="token string">'S'</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># Start</span>
                        self<span class="token punctuation">.</span>draw_box<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">)</span>
                    <span class="token keyword">elif</span> self<span class="token punctuation">.</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> b<span class="token string">'F'</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># Frozen ice</span>
                        self<span class="token punctuation">.</span>draw_box<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">)</span>
                    <span class="token keyword">elif</span> self<span class="token punctuation">.</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> b<span class="token string">'G'</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># Goal</span>
                        self<span class="token punctuation">.</span>draw_box<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'yellow'</span><span class="token punctuation">)</span>
                    <span class="token keyword">elif</span> self<span class="token punctuation">.</span>desc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> b<span class="token string">'H'</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># Hole</span>
                        self<span class="token punctuation">.</span>draw_box<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>draw_box<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>shape<span class="token punctuation">(</span><span class="token string">'turtle'</span><span class="token punctuation">)</span>

        x_pos <span class="token operator">=</span> self<span class="token punctuation">.</span>s <span class="token operator">%</span> self<span class="token punctuation">.</span>max_x
        y_pos <span class="token operator">=</span> self<span class="token punctuation">.</span>max_y <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> int<span class="token punctuation">(</span>self<span class="token punctuation">.</span>s <span class="token operator">/</span> self<span class="token punctuation">.</span>max_x<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>move_player<span class="token punctuation">(</span>x_pos<span class="token punctuation">,</span> y_pos<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">CliffWalkingWapper</span><span class="token punctuation">(</span>gym<span class="token punctuation">.</span>Wrapper<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">:</span>
        gym<span class="token punctuation">.</span>Wrapper<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> env<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t <span class="token operator">=</span> None
        self<span class="token punctuation">.</span>unit <span class="token operator">=</span> <span class="token number">50</span>
        self<span class="token punctuation">.</span>max_x <span class="token operator">=</span> <span class="token number">12</span>
        self<span class="token punctuation">.</span>max_y <span class="token operator">=</span> <span class="token number">4</span>

    <span class="token keyword">def</span> <span class="token function">draw_x_line</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> y<span class="token punctuation">,</span> x0<span class="token punctuation">,</span> x1<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> x1 <span class="token operator">></span> x0
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>color<span class="token punctuation">(</span>color<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>setheading<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>up<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>x0<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>down<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>x1 <span class="token operator">-</span> x0<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">draw_y_line</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y0<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> y1 <span class="token operator">></span> y0
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>color<span class="token punctuation">(</span>color<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>setheading<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>up<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y0<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>down<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>y1 <span class="token operator">-</span> y0<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">draw_box</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> fillcolor<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> line_color<span class="token operator">=</span><span class="token string">'gray'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>up<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>goto<span class="token punctuation">(</span>x <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">,</span> y <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>color<span class="token punctuation">(</span>line_color<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>fillcolor<span class="token punctuation">(</span>fillcolor<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>setheading<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>down<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>begin_fill<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>right<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>end_fill<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">move_player</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>up<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>setheading<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>fillcolor<span class="token punctuation">(</span><span class="token string">'red'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>goto<span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">,</span> <span class="token punctuation">(</span>y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>t <span class="token operator">==</span> None<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>t <span class="token operator">=</span> turtle<span class="token punctuation">.</span>Turtle<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wn <span class="token operator">=</span> turtle<span class="token punctuation">.</span>Screen<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wn<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>self<span class="token punctuation">.</span>unit <span class="token operator">*</span> self<span class="token punctuation">.</span>max_x <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">,</span>
                          self<span class="token punctuation">.</span>unit <span class="token operator">*</span> self<span class="token punctuation">.</span>max_y <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>wn<span class="token punctuation">.</span>setworldcoordinates<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>unit <span class="token operator">*</span> self<span class="token punctuation">.</span>max_x<span class="token punctuation">,</span>
                                        self<span class="token punctuation">.</span>unit <span class="token operator">*</span> self<span class="token punctuation">.</span>max_y<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>shape<span class="token punctuation">(</span><span class="token string">'circle'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>width<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>speed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>color<span class="token punctuation">(</span><span class="token string">'gray'</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_x <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>left<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_y <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>left<span class="token punctuation">(</span><span class="token number">90</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_y<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>draw_x_line<span class="token punctuation">(</span>
                    y<span class="token operator">=</span>i <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">,</span> x0<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> x1<span class="token operator">=</span>self<span class="token punctuation">.</span>max_x <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_x<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>draw_y_line<span class="token punctuation">(</span>
                    x<span class="token operator">=</span>i <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">,</span> y0<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> y1<span class="token operator">=</span>self<span class="token punctuation">.</span>max_y <span class="token operator">*</span> self<span class="token punctuation">.</span>unit<span class="token punctuation">)</span>

            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>draw_box<span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>draw_box<span class="token punctuation">(</span>self<span class="token punctuation">.</span>max_x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'yellow'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>t<span class="token punctuation">.</span>shape<span class="token punctuation">(</span><span class="token string">'turtle'</span><span class="token punctuation">)</span>

        x_pos <span class="token operator">=</span> self<span class="token punctuation">.</span>s <span class="token operator">%</span> self<span class="token punctuation">.</span>max_x
        y_pos <span class="token operator">=</span> self<span class="token punctuation">.</span>max_y <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> int<span class="token punctuation">(</span>self<span class="token punctuation">.</span>s <span class="token operator">/</span> self<span class="token punctuation">.</span>max_x<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>move_player<span class="token punctuation">(</span>x_pos<span class="token punctuation">,</span> y_pos<span class="token punctuation">)</span>

</code></pre>
<h3 id="On-policy和Off-policy"><a href="#On-policy和Off-policy" class="headerlink" title="On-policy和Off-policy"></a>On-policy和Off-policy</h3><p>On-policy: 探索环境使用的策略和要更新的策略是一个策略（SARSA）</p>
<p>Off-policy: 探索环境使用的策略和要更新的策略不是同一个策略（Q-learning）</p>
<p>上面我们学的SARSA是on-policy，优化的是实际执行的策略，因此只存在一种策略。off-policy在学习的过程中保留了两种不同的策略，一种是Target policy，使我们想要的最佳的目标策略。另一个是Behavior policy，是探索环境的策略，需要大胆探索所有可能的环境，然后交给目标策略去学习。而且交给目标策略的数据不需要$A_{t+1}$（也就是Sarsa最后一个a）。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/17.png" class>

<p>对比：</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/18.png" class>



<h3 id="Q-learning"><a href="#Q-learning" class="headerlink" title="Q-learning"></a>Q-learning</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/19.png" class>

<p>可以看到代码实现方面Q-learning和Sarsa类似，只是把初始action的选择也放到了循环当中，并且learn函数已经不用传入$A_{t+1}$了。</p>
<p>而在Agent类中，只有learn函数中的一行和Sarsa有区别，也就是Q表格的更新公式。</p>
<pre class=" language-python"><code class="language-python">
<span class="token keyword">class</span> <span class="token class-name">QLearningAgent</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token operator">-</span><span class="token operator">-</span>snip<span class="token operator">-</span><span class="token operator">-</span>
    <span class="token comment" spellcheck="true"># 学习方法，也就是更新Q-table的方法</span>
    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" off-policy
            obs: 交互前的obs, s_t
            action: 本次交互选择的action, a_t
            reward: 本次动作获得的奖励r
            next_obs: 本次交互后的obs, s_t+1
            done: episode是否结束
        """</span>
        predict_Q <span class="token operator">=</span> self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">]</span>
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            target_Q <span class="token operator">=</span> reward  <span class="token comment" spellcheck="true"># 没有下一个状态了</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            target_Q <span class="token operator">=</span> reward <span class="token operator">+</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> np<span class="token punctuation">.</span>max<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>next_obs<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># Q-learning</span>
        self<span class="token punctuation">.</span>Q<span class="token punctuation">[</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">]</span> <span class="token operator">+=</span> self<span class="token punctuation">.</span>lr <span class="token operator">*</span> <span class="token punctuation">(</span>target_Q <span class="token operator">-</span> predict_Q<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 修正q</span>
    <span class="token operator">-</span><span class="token operator">-</span>snip<span class="token operator">-</span><span class="token operator">-</span></code></pre>
<p>也就是说，探索的策略没变，都是往高价值的格子方向探索并带有10%的探索几率。但是更新格子价值的时候，我们并不是根据探索的下一步来调整格子的价值，而是挑选周围全部可以达到的格子价值的最大值。因此，<strong>在Q-learning中，价值低的格子并不能影响周围格子的价值，只有价值高的格子才能影响周围格子的价值。</strong></p>
<p>这和Sarsa不同，Sarsa下一步格子的价值都会影响到上一步格子，因此在reward为负数的格子周围那些格子的价值也为负数，因此agent会绕的远远地。而Q-learning，没有这个顾虑，因此agent直接就是最短路径拿到reward，因此total-reward会比Sarsa高。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/20.png" class>



<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Sarsa的策略偏向于保守，既会趋利也会避害，即使探索不太完全也会里reward底的地方较远（防止随机走的时候掉进去），而Q-learning更具探索性，能找到一条最优的路径，但是探索的时候Behavior policy容易随机reward低点，但这不妨碍Target policy学习到更好的策略。</p>
<p><strong>其中每走一步reward减1的设定是探索的关键点。</strong>由于没有探索到的格子价值为0，而探索到的无reward格子的价值往往为负数，agent会更趋向于探索没有探索过的格子。</p>
<p>那么Sarsa和Q-learning这两个<strong>经典的表格型算法</strong>和编程实现到此讲解完毕。</p>
<h3 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/21.png" class>

<p>讲到这里，你应该已经了解两个算法的具体实现了，到多个环境中去跑算法观察现象吧！我们可以自定义格子世界，看看我们的算法是如何找到最优路径的。</p>
<p>同时，我也发现这两个算法都有一定的缺陷，就是没有办法跑黑块较多且较大的地图，这是由于战线过长中途又没有反馈，因此agent很难知道自己走的路线是对是错，我个人的想法是，往往这时候我们需要人为加入额外的reward来引导。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/22.png" class>



<h2 id="基于神经网络方法求解RL"><a href="#基于神经网络方法求解RL" class="headerlink" title="基于神经网络方法求解RL"></a>基于神经网络方法求解RL</h2><p>关于神经网络的内容可以自行查看深度学习内容，或查看我的文章《李宏毅机器学习2021》<a href="https://tianjuewudi.gitee.io/2021/05/07/li-hong-yi-ji-qi-xue-xi-2021/%E3%80%82%E4%BB%A5%E5%8F%8A%E3%80%8APytorch%E5%AE%9E%E6%88%98%E6%95%99%E5%AD%A6%E3%80%8B%E3%80%82">https://tianjuewudi.gitee.io/2021/05/07/li-hong-yi-ji-qi-xue-xi-2021/。以及《Pytorch实战教学》。</a></p>
<p> 当我们的强化学习（RL）碰到了深度学习（DL），我们就来到了深度强化学习（DRL）的领域。</p>
<p>表格法有很大的缺陷：</p>
<ol>
<li>表格占用的内存空间巨大。</li>
<li>当表格极大时，查表效率低下。</li>
<li>只能表示有限个离散状态和动作。</li>
</ol>
<p>现在我们需要更换工具了，我们可以用神经网络来代替表格法，我们可以用S和A作为神经网络的输入，由此输出价值Q。也可以输入S并输出多个Q，每个Q对应一个A。神经网络只需要储存有限的网络参数，我们的任务就是不断调整这些参数，使得输入输出符合我们的预期，而且状态可以泛化，相似的状态输出也差不多，不用像表格法一样需要重新训练。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/23.png" class>

<p>其中利用神经网络求解RL的经典算法是<strong>DQN</strong>。这是2015年发表在Nature上的论文。神经网络的输入是像素级别的图像，使用神经网络近似代替Q表格，49个游戏中有30个超越人类水平。</p>
<h3 id="DQN"><a href="#DQN" class="headerlink" title="DQN"></a>DQN</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/24.png" class>

<p>DQN的做法类似于Q-learning和神经网络的组合。首先神经网络的训练方法是监督学习，其中训练的样本就是输入状态变量，输出动作Action，我们通过Q-learning不断更新这些样本，然后送到神经网络中进行训练，期望拟合出一个和原来Q表格差不多的神经网络。</p>
<p>DQN提出了两个创新点使得其更有效率也更稳定。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/25.png" class>

<p>第一个是<strong>经验回放</strong>。经验回放可以充分利用off-policy的优势，可以利用Behavior Policy探索的数据特征形成一组组数据，并且可以随机打乱，使得神经网络可以重复多次地进行学习。这样可以打乱样本的关联性，而且能提高样本利用率。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/26.png" class>

<p>第二个是<strong>固定Q目标</strong>。增加了算法的平稳性。由于在探索过程中的Q也是时时刻刻都在变化的，因此我们训练的神经网络很难去逼近它的值，因此我们需要把Q值固定一段时间来训练参数，这是Q网络。我们需要另外一个一样的网络（target Q网络），Q网络的作用是产生一个Q预测值，直接用来决策产生action。而target Q是产生一个Q目标值，我们需要训练网络让这两个值越接近越好，这个Loss就是网络需要优化的目标，利用这个Loss我们就可以更新Q网络的参数。刚开始我们的网络的输出是随机的，但是受到reward的影响，各个状态的价值随着更新都会逐渐区分开来。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/27.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/28.png" class>

<p>这也是PARL这个框架的特点，它把算法框架拆分为model，algorithm，agent三个部分</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/29.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/30.png" class>



<h3 id="代码实现（失败）"><a href="#代码实现（失败）" class="headerlink" title="代码实现（失败）"></a>代码实现（失败）</h3><p>reply_memory.py：用来把一个batch的资料分类整理。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ReplayMemory</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># deque是高性能的数据结构之一，是一个队列</span>
        self<span class="token punctuation">.</span>buffer <span class="token operator">=</span> collections<span class="token punctuation">.</span>deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span>max_size<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 往队列中添加一条数据</span>
    <span class="token keyword">def</span> <span class="token function">append</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>exp<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 随机取出batch_size条数据</span>
        mini_batch <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>self<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>
        obs_batch<span class="token punctuation">,</span> action_batch<span class="token punctuation">,</span> reward_batch<span class="token punctuation">,</span> next_obs_batch<span class="token punctuation">,</span> done_batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment" spellcheck="true"># 数据分类存放到列表中</span>
        <span class="token keyword">for</span> experience <span class="token keyword">in</span> mini_batch<span class="token punctuation">:</span>
            s<span class="token punctuation">,</span> a<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s_p<span class="token punctuation">,</span> done <span class="token operator">=</span> experience
            obs_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
            action_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
            reward_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            next_obs_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s_p<span class="token punctuation">)</span>
            done_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>done<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># 返回分类存放一个batch数据的numpy数组</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>obs_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \
            np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>action_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>reward_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\
            np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>next_obs_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>done_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span>
</code></pre>
<p>首先是模型model.py：</p>
<p>定义了3层的全连接网络，输入维数为1，输入为act_dim维。中间层分别是128和128个节点的全连接层。</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl<span class="token punctuation">.</span>core<span class="token punctuation">.</span>fluid <span class="token keyword">import</span> layers  <span class="token comment" spellcheck="true"># 封装了 paddle.fluid.layers 的API</span>

<span class="token keyword">class</span> <span class="token class-name">Model</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># 定义了网络的结构</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> act_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        hid1_size <span class="token operator">=</span> <span class="token number">128</span>
        hid2_size <span class="token operator">=</span> <span class="token number">128</span>
        <span class="token comment" spellcheck="true"># 3层全连接网络</span>
        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> layers<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>size<span class="token operator">=</span>hid1_size<span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> layers<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>size<span class="token operator">=</span>hid2_size<span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc3 <span class="token operator">=</span> layers<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>size<span class="token operator">=</span>act_dim<span class="token punctuation">,</span> act<span class="token operator">=</span>None<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 决定了网络的输出</span>
    <span class="token keyword">def</span> <span class="token function">value</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        h1 <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        h2 <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>h1<span class="token punctuation">)</span>
        Q <span class="token operator">=</span> self<span class="token punctuation">.</span>fc3<span class="token punctuation">(</span>h2<span class="token punctuation">)</span>
        <span class="token keyword">return</span> Q</code></pre>
<p>algorithm.py，DQN算法的精髓：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> copy
<span class="token keyword">import</span> paddle<span class="token punctuation">.</span>fluid <span class="token keyword">as</span> fluid
<span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl<span class="token punctuation">.</span>core<span class="token punctuation">.</span>fluid <span class="token keyword">import</span> layers


<span class="token keyword">class</span> <span class="token class-name">DQN</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Algorithm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> act_dim<span class="token operator">=</span>None<span class="token punctuation">,</span> gamma<span class="token operator">=</span>None<span class="token punctuation">,</span> lr<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" DQN algorithm    
        Args:
            model (parl.Model): 定义Q函数的前向网络结构
            act_dim (int): action空间的维度，即有几个action
            gamma (float): reward的衰减因子
            lr (float): learning_rate，学习率.
        """</span>
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        <span class="token comment" spellcheck="true"># 复制一个一模一样的网络</span>
        self<span class="token punctuation">.</span>target_model <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># assert插入调试断点到程序，这里用isinstance判断数据类型是否正确，否则抛出异常</span>
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>act_dim<span class="token punctuation">,</span> int<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>gamma<span class="token punctuation">,</span> float<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>lr<span class="token punctuation">,</span> float<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>act_dim <span class="token operator">=</span> act_dim
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma
        self<span class="token punctuation">.</span>lr <span class="token operator">=</span> lr

    <span class="token comment" spellcheck="true"># 使用self.model的value网络来获取 [Q(s,a1),Q(s,a2),...]    </span>
    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>value<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 使用DQN算法更新self.model的value网络,传进的参数是一个个数组，是一个batch中的数据，返回Loss</span>
    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> terminal<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 从target_model中获取 max Q' 的值，用于计算target_Q</span>
        next_pred_value <span class="token operator">=</span> self<span class="token punctuation">.</span>target_model<span class="token punctuation">.</span>value<span class="token punctuation">(</span>next_obs<span class="token punctuation">)</span>
        best_v <span class="token operator">=</span> layers<span class="token punctuation">.</span>reduce_max<span class="token punctuation">(</span>next_pred_value<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        best_v<span class="token punctuation">.</span>stop_gradient <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment" spellcheck="true"># 阻止梯度传递，Target Model不需要训练</span>
        terminal <span class="token operator">=</span> layers<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>terminal<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># bool变量转换成浮点数</span>
        target <span class="token operator">=</span> reward <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> terminal<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> best_v  <span class="token comment" spellcheck="true"># 这样就可以把公式统一</span>

        pred_value <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>value<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 获取Q预测值</span>
        <span class="token comment" spellcheck="true"># 将action转onehot向量，比如：3 => [0,0,0,1,0]</span>
        action_onehot <span class="token operator">=</span> layers<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>action<span class="token punctuation">,</span> self<span class="token punctuation">.</span>act_dim<span class="token punctuation">)</span>
        action_onehot <span class="token operator">=</span> layers<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>action_onehot<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># 下面一行是逐元素相乘，拿到action对应的 Q(s,a)</span>
        <span class="token comment" spellcheck="true"># 比如：pred_value = [[2.3, 5.7, 1.2, 3.9, 1.4]], action_onehot = [[0,0,0,1,0]]</span>
        <span class="token comment" spellcheck="true">#  ==> pred_action_value = [[3.9]]</span>
        pred_action_value <span class="token operator">=</span> layers<span class="token punctuation">.</span>reduce_sum<span class="token punctuation">(</span>
            layers<span class="token punctuation">.</span>elementwise_mul<span class="token punctuation">(</span>action_onehot<span class="token punctuation">,</span> pred_value<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># 计算 Q(s,a) 与 target_Q的均方差，得到loss</span>
        cost <span class="token operator">=</span> layers<span class="token punctuation">.</span>square_error_cost<span class="token punctuation">(</span>pred_action_value<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
        cost <span class="token operator">=</span> layers<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>
        optimizer <span class="token operator">=</span> fluid<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span>self<span class="token punctuation">.</span>lr<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 使用Adam优化器</span>
        optimizer<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>                                 <span class="token comment" spellcheck="true"># 训练</span>
        <span class="token keyword">return</span> cost

    <span class="token comment" spellcheck="true"># 把 self.model 的模型参数值同步到 self.target_model</span>
    <span class="token keyword">def</span> <span class="token function">sync_target</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sync_weights_to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>target_model<span class="token punctuation">)</span>
</code></pre>
<p>我们看看程序是如何更新神经网络的，我们知道神经网络是代替存储Q表格的地方，首先，我们存在两个神经网络，一个输出预测值，一个输出目标值。首先我们需要通过Target Q网络计算输出的目标值，由于网络没有充分训练，这个值是不准确的。然后我们获取了Q网络的预测值，由于它也没有经过充分训练，这个预测值也是不准确的。虽然不准确，但是我们还是需要<strong>训练Q网络让预测值靠近依靠Target Q网络计算的目标值</strong>。这就是Learn函数做的事情。</p>
<p>agent.py：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> paddle<span class="token punctuation">.</span>fluid <span class="token keyword">as</span> fluid
<span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl<span class="token punctuation">.</span>core<span class="token punctuation">.</span>fluid <span class="token keyword">import</span> layers


<span class="token keyword">class</span> <span class="token class-name">Agent</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>algorithm<span class="token punctuation">,</span>obs_dim<span class="token punctuation">,</span>act_dim<span class="token punctuation">,</span>e_greed<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>e_greed_decrement<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>obs_dim<span class="token punctuation">,</span> int<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>act_dim<span class="token punctuation">,</span> int<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>obs_dim <span class="token operator">=</span> obs_dim
        self<span class="token punctuation">.</span>act_dim <span class="token operator">=</span> act_dim
        super<span class="token punctuation">(</span>Agent<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>global_step <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>update_target_steps <span class="token operator">=</span> <span class="token number">200</span>  <span class="token comment" spellcheck="true"># 每隔200个training steps再把model的参数复制到target_model中</span>

        self<span class="token punctuation">.</span>e_greed <span class="token operator">=</span> e_greed  <span class="token comment" spellcheck="true"># 有一定概率随机选取动作，探索</span>
        self<span class="token punctuation">.</span>e_greed_decrement <span class="token operator">=</span> e_greed_decrement  <span class="token comment" spellcheck="true"># 随着训练逐步收敛，探索的程度慢慢降低</span>

    <span class="token keyword">def</span> <span class="token function">build_program</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pred_program <span class="token operator">=</span> fluid<span class="token punctuation">.</span>Program<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>learn_program <span class="token operator">=</span> fluid<span class="token punctuation">.</span>Program<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">with</span> fluid<span class="token punctuation">.</span>program_guard<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pred_program<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 搭建计算图用于 预测动作，定义输入输出变量</span>
            obs <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>
                name<span class="token operator">=</span><span class="token string">'obs'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>obs_dim<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>value <span class="token operator">=</span> self<span class="token punctuation">.</span>alg<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>

        <span class="token keyword">with</span> fluid<span class="token punctuation">.</span>program_guard<span class="token punctuation">(</span>self<span class="token punctuation">.</span>learn_program<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 搭建计算图用于 更新Q网络，定义输入输出变量</span>
            obs <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>
                name<span class="token operator">=</span><span class="token string">'obs'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>obs_dim<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            action <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'act'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'int32'</span><span class="token punctuation">)</span>
            reward <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'reward'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            next_obs <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>
                name<span class="token operator">=</span><span class="token string">'next_obs'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>obs_dim<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            terminal <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'terminal'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'bool'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>cost <span class="token operator">=</span> self<span class="token punctuation">.</span>alg<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> terminal<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sample <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 产生0~1之间的小数</span>
        <span class="token keyword">if</span> sample <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>e_greed<span class="token punctuation">:</span>
            act <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>self<span class="token punctuation">.</span>act_dim<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 探索：每个动作都有概率被选择</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            act <span class="token operator">=</span> self<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 选择最优动作</span>
        self<span class="token punctuation">.</span>e_greed <span class="token operator">=</span> max<span class="token punctuation">(</span>
            <span class="token number">0.01</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>e_greed <span class="token operator">-</span> self<span class="token punctuation">.</span>e_greed_decrement<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 随着训练逐步收敛，探索的程度慢慢降低</span>
        <span class="token keyword">return</span> act

    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 选择最优动作</span>
        obs <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        pred_Q <span class="token operator">=</span> self<span class="token punctuation">.</span>fluid_executor<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>pred_program<span class="token punctuation">,</span>
            feed<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'obs'</span><span class="token punctuation">:</span> obs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            fetch_list<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        pred_Q <span class="token operator">=</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>pred_Q<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        act <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>pred_Q<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 选择Q最大的下标，即对应的动作</span>
        <span class="token keyword">return</span> act

    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> act<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> terminal<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 每隔200个training steps同步一次model和target_model的参数</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>global_step <span class="token operator">%</span> self<span class="token punctuation">.</span>update_target_steps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>alg<span class="token punctuation">.</span>sync_target<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>global_step <span class="token operator">+=</span> <span class="token number">1</span>

        act <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>act<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        feed <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'obs'</span><span class="token punctuation">:</span> obs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'act'</span><span class="token punctuation">:</span> act<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'reward'</span><span class="token punctuation">:</span> reward<span class="token punctuation">,</span>
            <span class="token string">'next_obs'</span><span class="token punctuation">:</span> next_obs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'terminal'</span><span class="token punctuation">:</span> terminal
        <span class="token punctuation">}</span>
        cost <span class="token operator">=</span> self<span class="token punctuation">.</span>fluid_executor<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>learn_program<span class="token punctuation">,</span> feed<span class="token operator">=</span>feed<span class="token punctuation">,</span> fetch_list<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>cost<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># 训练一次网络</span>
        <span class="token keyword">return</span> cost</code></pre>
<p>train.py:执行代码所在</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> gym
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl<span class="token punctuation">.</span>utils <span class="token keyword">import</span> logger  <span class="token comment" spellcheck="true"># 日志打印工具</span>

<span class="token keyword">from</span> model <span class="token keyword">import</span> Model
<span class="token keyword">from</span> algorithm <span class="token keyword">import</span> DQN
<span class="token comment" spellcheck="true">#from parl.algorithms import DQN</span>
<span class="token keyword">from</span> agent <span class="token keyword">import</span> Agent

<span class="token keyword">from</span> replay_memory <span class="token keyword">import</span> ReplayMemory

LEARN_FREQ <span class="token operator">=</span> <span class="token number">5</span>  <span class="token comment" spellcheck="true"># 训练频率，不需要每一个step都learn，攒一些新增经验后再learn，提高效率</span>
MEMORY_SIZE <span class="token operator">=</span> <span class="token number">20000</span>  <span class="token comment" spellcheck="true"># replay memory的大小，越大越占用内存</span>
MEMORY_WARMUP_SIZE <span class="token operator">=</span> <span class="token number">200</span>  <span class="token comment" spellcheck="true"># replay_memory 里需要预存一些经验数据，再从里面sample一个batch的经验让agent去learn</span>
BATCH_SIZE <span class="token operator">=</span> <span class="token number">32</span>  <span class="token comment" spellcheck="true"># 每次给agent learn的数据数量，从replay memory随机里sample一批数据出来</span>
LEARNING_RATE <span class="token operator">=</span> <span class="token number">0.001</span>  <span class="token comment" spellcheck="true"># 学习率</span>
GAMMA <span class="token operator">=</span> <span class="token number">0.99</span>  <span class="token comment" spellcheck="true"># reward 的衰减因子，一般取 0.9 到 0.999 不等</span>


<span class="token comment" spellcheck="true"># 训练一个episode</span>
<span class="token keyword">def</span> <span class="token function">run_episode</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> rpm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    total_reward <span class="token operator">=</span> <span class="token number">0</span>
    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    step <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        step <span class="token operator">+=</span> <span class="token number">1</span>
        action <span class="token operator">=</span> agent<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 采样动作，所有动作都有概率被尝试到</span>
        next_obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        rpm<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># train model</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len<span class="token punctuation">(</span>rpm<span class="token punctuation">)</span> <span class="token operator">></span> MEMORY_WARMUP_SIZE<span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span>step <span class="token operator">%</span> LEARN_FREQ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">(</span>batch_obs<span class="token punctuation">,</span> batch_action<span class="token punctuation">,</span> batch_reward<span class="token punctuation">,</span> batch_next_obs<span class="token punctuation">,</span>
             batch_done<span class="token punctuation">)</span> <span class="token operator">=</span> rpm<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>BATCH_SIZE<span class="token punctuation">)</span>
            train_loss <span class="token operator">=</span> agent<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>batch_obs<span class="token punctuation">,</span> batch_action<span class="token punctuation">,</span> batch_reward<span class="token punctuation">,</span>
                                     batch_next_obs<span class="token punctuation">,</span>
                                     batch_done<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># s,a,r,s',done</span>

        total_reward <span class="token operator">+=</span> reward
        obs <span class="token operator">=</span> next_obs
        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> total_reward


<span class="token comment" spellcheck="true"># 评估 agent, 跑 5 个episode，总reward求平均</span>
<span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    eval_reward <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        episode_reward <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> agent<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 预测动作，只选最优动作</span>
            obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            episode_reward <span class="token operator">+=</span> reward
            <span class="token keyword">if</span> render<span class="token punctuation">:</span>
                env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> done<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        eval_reward<span class="token punctuation">.</span>append<span class="token punctuation">(</span>episode_reward<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>eval_reward<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span>
        <span class="token string">'CartPole-v0'</span>
    <span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># CartPole-v0: expected reward > 180                MountainCar-v0 : expected reward > -120</span>
    action_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n  <span class="token comment" spellcheck="true"># CartPole-v0: 2</span>
    obs_shape <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape  <span class="token comment" spellcheck="true"># CartPole-v0: (4,)</span>

    rpm <span class="token operator">=</span> ReplayMemory<span class="token punctuation">(</span>MEMORY_SIZE<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># DQN的经验回放池</span>

    <span class="token comment" spellcheck="true"># 根据parl框架构建agent</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>act_dim<span class="token operator">=</span>action_dim<span class="token punctuation">)</span>
    algorithm <span class="token operator">=</span> DQN<span class="token punctuation">(</span>model<span class="token punctuation">,</span> act_dim<span class="token operator">=</span>action_dim<span class="token punctuation">,</span> gamma<span class="token operator">=</span>GAMMA<span class="token punctuation">,</span> lr<span class="token operator">=</span>LEARNING_RATE<span class="token punctuation">)</span>
    agent <span class="token operator">=</span> Agent<span class="token punctuation">(</span>
        algorithm<span class="token punctuation">,</span>
        obs_dim<span class="token operator">=</span>obs_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        act_dim<span class="token operator">=</span>action_dim<span class="token punctuation">,</span>
        e_greed<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true"># 有一定概率随机选取动作，探索</span>
        e_greed_decrement<span class="token operator">=</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 随着训练逐步收敛，探索的程度慢慢降低</span>

    <span class="token comment" spellcheck="true"># 加载模型</span>
    <span class="token comment" spellcheck="true"># save_path = './dqn_model.ckpt'</span>
    <span class="token comment" spellcheck="true"># agent.restore(save_path)</span>

    <span class="token comment" spellcheck="true"># 先往经验池里存一些数据，避免最开始训练的时候样本丰富度不够</span>
    <span class="token keyword">while</span> len<span class="token punctuation">(</span>rpm<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MEMORY_WARMUP_SIZE<span class="token punctuation">:</span>
        run_episode<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> rpm<span class="token punctuation">)</span>

    max_episode <span class="token operator">=</span> <span class="token number">2000</span>

    <span class="token comment" spellcheck="true"># start train</span>
    episode <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> episode <span class="token operator">&lt;</span> max_episode<span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 训练max_episode个回合，test部分不计算入episode数量</span>
        <span class="token comment" spellcheck="true"># train part</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            total_reward <span class="token operator">=</span> run_episode<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> rpm<span class="token punctuation">)</span>
            episode <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token comment" spellcheck="true"># test part</span>
        eval_reward <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># render=True 查看显示效果</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'episode:{}    e_greed:{}   Test reward:{}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>
            episode<span class="token punctuation">,</span> agent<span class="token punctuation">.</span>e_greed<span class="token punctuation">,</span> eval_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 训练结束，保存模型</span>
    save_path <span class="token operator">=</span> <span class="token string">'./dqn_model.ckpt'</span>
    agent<span class="token punctuation">.</span>save<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p><strong>由于库的版本问题，我这里是运行失败的，原因是parl没有layers这个类。。。所以这里我只知道一些实现思路，如果知道新版的代码写法，可以联系我。</strong></p>
<h2 id="CartPole"><a href="#CartPole" class="headerlink" title="CartPole"></a>CartPole</h2><p>CartPole的环境相当于强化学习中的“Hello World”，是最基础的环境，任何强化学习算法都可以在上面运行并测试是否收敛。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/31.png" class>

<h3 id="PARL常用API"><a href="#PARL常用API" class="headerlink" title="PARL常用API"></a>PARL常用API</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/32.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/33.png" class>

<h3 id><a href="#" class="headerlink" title></a></h3><h2 id="基于策略梯度求解RL"><a href="#基于策略梯度求解RL" class="headerlink" title="基于策略梯度求解RL"></a>基于策略梯度求解RL</h2><p>  上面我们所学的是value-based，通过探索将Q价值更新到最优，然后根据Q价值来选择最优的动作。下面我们讲policy-based，动作选择不再依赖价值函数，而是根据一个策略走到底，看最后的总收益决定算法好坏，好Action将在以后有更大的概率被随机到。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/34.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/35.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/36.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/37.png" class>

<p>可以看到，智能体通过直接输出一个动作选择的概率来选择下一步的action，这个策略是可以优化的，但是执行一个action之后有多种状态的可能性，这也就是环境的随机性。不断输出动作到新的状态到游戏结束称为完成一个episode，这一串的交互称为一个episode的轨迹（Trajectory）。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/38.png" class>

<p><strong>期望回报</strong>是穷举所有在该策略下的轨迹能拿到的回报（Reward）的平均值，在实际运用中我们无法穷举，也不能得出状态转移概率，但是我们可以通过运行多个episode然后将得到的reward取平均近似认为是期望回报。</p>
<p>由于我们没有label对我们的网络进行更新，这时候就需要利用我们的期望回报了，我们通过梯度上升法使得我们的reward变大，那么就能使得策略变好，经过推导可以得出我们更新的梯度公式如下：</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/39.png" class>



<h3 id="蒙特卡洛（MC）和时序差分（TD）"><a href="#蒙特卡洛（MC）和时序差分（TD）" class="headerlink" title="蒙特卡洛（MC）和时序差分（TD）"></a>蒙特卡洛（MC）和时序差分（TD）</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/40.png" class>

<p>蒙特卡洛是完成一个episode之后，再做一次更新，其中$G_t$指的是在一个step之后能拿到的总收益之和。而时序差分指的是每一个step都更新数据。用的是Q function来近似表示总收益。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/41.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/45.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/42.png" class>

<h3 id="Policy-Gradient"><a href="#Policy-Gradient" class="headerlink" title="Policy Gradient"></a>Policy Gradient</h3><p>重点来了！！！我们使用的更新方式是Policy Gradient，也就是策略梯度，我们的loss依旧通过交叉熵方式获得，但还需要乘以一个$G_t$作为权重，也就是我们<strong>计算出来的总收益</strong>！总收益越高的说明我们的决策越好，$G_t$越大，我网络会用较大的梯度来进行更新，反之$G_t$较小则用小梯度更新。这样进行多次更新之后，我们网络算出来的决策就会越来越趋近于好的决策。</p>
<p>对于离散的动作，我们直接采用价值计算的原始公式，然后用梯度上升法即可，具体操作可以用蒙泰卡罗采样的方法代替：</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/61.png" class>

<p>对于连续动作（对于离散动作同样适用），例如代码中的例子：</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/62.png" class>

<p>总结：</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/63.png" class>

<p>其中对于每个动作价值Q的计算都是在完成一个episode之后，利用带折扣的Reward从后往前进行计算的。还有一种就是利用神经网络来近似价值函数的方法，称为Actor-Critic。</p>
<h3 id="-1"><a href="#-1" class="headerlink" title></a></h3><p>对应代码：</p>
<pre class=" language-python"><code class="language-python">    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 用policy gradient 算法更新policy model
        """</span>
        act_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 获取输出动作概率</span>
        <span class="token comment" spellcheck="true"># log_prob = layers.cross_entropy(act_prob, action) # 交叉熵</span>
        log_prob <span class="token operator">=</span> layers<span class="token punctuation">.</span>reduce_sum<span class="token punctuation">(</span>
            <span class="token operator">-</span><span class="token number">1.0</span> <span class="token operator">*</span> layers<span class="token punctuation">.</span>log<span class="token punctuation">(</span>act_prob<span class="token punctuation">)</span> <span class="token operator">*</span> layers<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>
                action<span class="token punctuation">,</span> act_prob<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        cost <span class="token operator">=</span> log_prob <span class="token operator">*</span> reward
        cost <span class="token operator">=</span> layers<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>

        optimizer <span class="token operator">=</span> fluid<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lr<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cost
</code></pre>
<h3 id="流程及代码："><a href="#流程及代码：" class="headerlink" title="流程及代码："></a>流程及代码：</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/43.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/44.png" class>

<p>model.py：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl <span class="token keyword">import</span> layers


<span class="token keyword">class</span> <span class="token class-name">Model</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> act_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        act_dim <span class="token operator">=</span> act_dim
        hid1_size <span class="token operator">=</span> act_dim <span class="token operator">*</span> <span class="token number">10</span>

        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> layers<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>size<span class="token operator">=</span>hid1_size<span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'tanh'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> layers<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>size<span class="token operator">=</span>act_dim<span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 可直接用 model = Model(5); model(obs)调用</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>out<span class="token punctuation">)</span>
        <span class="token keyword">return</span> out
</code></pre>
<p>algorithm.py：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> paddle<span class="token punctuation">.</span>fluid <span class="token keyword">as</span> fluid
<span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl <span class="token keyword">import</span> layers

<span class="token keyword">class</span> <span class="token class-name">PolicyGradient</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Algorithm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> lr<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>lr<span class="token punctuation">,</span> float<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>lr <span class="token operator">=</span> lr

    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 使用policy model预测输出的动作概率
        """</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 用policy gradient 算法更新policy model
        """</span>
        act_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 获取输出动作概率</span>
        <span class="token comment" spellcheck="true"># log_prob = layers.cross_entropy(act_prob, action) # 交叉熵</span>
        log_prob <span class="token operator">=</span> layers<span class="token punctuation">.</span>reduce_sum<span class="token punctuation">(</span>
            <span class="token operator">-</span><span class="token number">1.0</span> <span class="token operator">*</span> layers<span class="token punctuation">.</span>log<span class="token punctuation">(</span>act_prob<span class="token punctuation">)</span> <span class="token operator">*</span> layers<span class="token punctuation">.</span>one_hot<span class="token punctuation">(</span>
                action<span class="token punctuation">,</span> act_prob<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        cost <span class="token operator">=</span> log_prob <span class="token operator">*</span> reward
        cost <span class="token operator">=</span> layers<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>

        optimizer <span class="token operator">=</span> fluid<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lr<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cost
</code></pre>
<p>agent.py：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> paddle<span class="token punctuation">.</span>fluid <span class="token keyword">as</span> fluid
<span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl <span class="token keyword">import</span> layers


<span class="token keyword">class</span> <span class="token class-name">Agent</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> algorithm<span class="token punctuation">,</span> obs_dim<span class="token punctuation">,</span> act_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>obs_dim <span class="token operator">=</span> obs_dim
        self<span class="token punctuation">.</span>act_dim <span class="token operator">=</span> act_dim
        super<span class="token punctuation">(</span>Agent<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">build_program</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>pred_program <span class="token operator">=</span> fluid<span class="token punctuation">.</span>Program<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>learn_program <span class="token operator">=</span> fluid<span class="token punctuation">.</span>Program<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">with</span> fluid<span class="token punctuation">.</span>program_guard<span class="token punctuation">(</span>self<span class="token punctuation">.</span>pred_program<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 搭建计算图用于 预测动作，定义输入输出变量</span>
            obs <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>
                name<span class="token operator">=</span><span class="token string">'obs'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>obs_dim<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>act_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>alg<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>

        <span class="token keyword">with</span> fluid<span class="token punctuation">.</span>program_guard<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>learn_program<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 搭建计算图用于 更新policy网络，定义输入输出变量</span>
            obs <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>
                name<span class="token operator">=</span><span class="token string">'obs'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>obs_dim<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            act <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'act'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'int64'</span><span class="token punctuation">)</span>
            reward <span class="token operator">=</span> layers<span class="token punctuation">.</span>data<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'reward'</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>cost <span class="token operator">=</span> self<span class="token punctuation">.</span>alg<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> act<span class="token punctuation">,</span> reward<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        obs <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 增加一维维度</span>
        act_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>fluid_executor<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>pred_program<span class="token punctuation">,</span>
            feed<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'obs'</span><span class="token punctuation">:</span> obs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            fetch_list<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>act_prob<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        act_prob <span class="token operator">=</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>act_prob<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 减少一维维度</span>
        act <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>range<span class="token punctuation">(</span>self<span class="token punctuation">.</span>act_dim<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token operator">=</span>act_prob<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 根据动作概率选取动作</span>
        <span class="token keyword">return</span> act

    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        obs <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        act_prob <span class="token operator">=</span> self<span class="token punctuation">.</span>fluid_executor<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>pred_program<span class="token punctuation">,</span>
            feed<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'obs'</span><span class="token punctuation">:</span> obs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            fetch_list<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>act_prob<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        act_prob <span class="token operator">=</span> np<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>act_prob<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        act <span class="token operator">=</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>act_prob<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 根据动作概率选择概率最高的动作</span>
        <span class="token keyword">return</span> act

    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> act<span class="token punctuation">,</span> reward<span class="token punctuation">)</span><span class="token punctuation">:</span>
        act <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>act<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        feed <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'obs'</span><span class="token punctuation">:</span> obs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'act'</span><span class="token punctuation">:</span> act<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int64'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">'reward'</span><span class="token punctuation">:</span> reward<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        cost <span class="token operator">=</span> self<span class="token punctuation">.</span>fluid_executor<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>learn_program<span class="token punctuation">,</span> feed<span class="token operator">=</span>feed<span class="token punctuation">,</span> fetch_list<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>cost<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> cost
</code></pre>
<p>train.py：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> gym
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> parl
<span class="token keyword">from</span> agent <span class="token keyword">import</span> Agent
<span class="token keyword">from</span> model <span class="token keyword">import</span> Model
<span class="token keyword">from</span> algorithm <span class="token keyword">import</span> PolicyGradient  <span class="token comment" spellcheck="true"># from parl.algorithms import PolicyGradient</span>

<span class="token keyword">from</span> parl<span class="token punctuation">.</span>utils <span class="token keyword">import</span> logger

LEARNING_RATE <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span>

<span class="token comment" spellcheck="true"># 训练一个episode</span>
<span class="token keyword">def</span> <span class="token function">run_episode</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    obs_list<span class="token punctuation">,</span> action_list<span class="token punctuation">,</span> reward_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        obs_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        action <span class="token operator">=</span> agent<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        action_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

        obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        reward_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reward<span class="token punctuation">)</span>

        <span class="token keyword">if</span> done<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> obs_list<span class="token punctuation">,</span> action_list<span class="token punctuation">,</span> reward_list

<span class="token comment" spellcheck="true"># 评估 agent, 跑 5 个episode，总reward求平均</span>
<span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    eval_reward <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        episode_reward <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            action <span class="token operator">=</span> agent<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
            obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> isOver<span class="token punctuation">,</span> _ <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            episode_reward <span class="token operator">+=</span> reward
            <span class="token keyword">if</span> render<span class="token punctuation">:</span>
                env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> isOver<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        eval_reward<span class="token punctuation">.</span>append<span class="token punctuation">(</span>episode_reward<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>eval_reward<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">calc_reward_to_go</span><span class="token punctuation">(</span>reward_list<span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>reward_list<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># G_i = r_i + γ·G_i+1</span>
        reward_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> gamma <span class="token operator">*</span> reward_list<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># Gt</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>reward_list<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    env <span class="token operator">=</span> gym<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'CartPole-v0'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># env = env.unwrapped # Cancel the minimum score limit</span>
    obs_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    act_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>n
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'obs_dim {}, act_dim {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>obs_dim<span class="token punctuation">,</span> act_dim<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 根据parl框架构建agent</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>act_dim<span class="token operator">=</span>act_dim<span class="token punctuation">)</span>
    alg <span class="token operator">=</span> PolicyGradient<span class="token punctuation">(</span>model<span class="token punctuation">,</span> lr<span class="token operator">=</span>LEARNING_RATE<span class="token punctuation">)</span>
    agent <span class="token operator">=</span> Agent<span class="token punctuation">(</span>alg<span class="token punctuation">,</span> obs_dim<span class="token operator">=</span>obs_dim<span class="token punctuation">,</span> act_dim<span class="token operator">=</span>act_dim<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 加载模型</span>
    <span class="token comment" spellcheck="true"># if os.path.exists('./model.ckpt'):</span>
    <span class="token comment" spellcheck="true">#     agent.restore('./model.ckpt')</span>
    <span class="token comment" spellcheck="true">#     run_episode(env, agent, train_or_test='test', render=True)</span>
    <span class="token comment" spellcheck="true">#     exit()</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        obs_list<span class="token punctuation">,</span> action_list<span class="token punctuation">,</span> reward_list <span class="token operator">=</span> run_episode<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">)</span>
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Episode {}, Reward Sum {}."</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>
                i<span class="token punctuation">,</span> sum<span class="token punctuation">(</span>reward_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        batch_obs <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>obs_list<span class="token punctuation">)</span>
        batch_action <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>action_list<span class="token punctuation">)</span>
        batch_reward <span class="token operator">=</span> calc_reward_to_go<span class="token punctuation">(</span>reward_list<span class="token punctuation">)</span>

        agent<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>batch_obs<span class="token punctuation">,</span> batch_action<span class="token punctuation">,</span> batch_reward<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            total_reward <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Test reward: {}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>total_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># save the parameters to ./model.ckpt</span>
    agent<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'./model.ckpt'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>由于库的版本问题，这里依旧没有运行成功。</p>
<h2 id="连续动作空间上求解RL"><a href="#连续动作空间上求解RL" class="headerlink" title="连续动作空间上求解RL"></a>连续动作空间上求解RL</h2><h3 id="离散动作和连续动作"><a href="#离散动作和连续动作" class="headerlink" title="离散动作和连续动作"></a>离散动作和连续动作</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/46.png" class>

<p>在连续动作空间的求解中，前面讲的Sarsa，DQN，Q-learning，Reinforce都是没有办法处理的。这时候我们就需要用神经网络的输出代表一个动作的“幅度”，而不是单纯决定做某个动作。例如我们可以用一个-1到1的输出来控制小车的速度，正数是前进，负数是后退，绝对值越大速度越快。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/47.png" class>

<h3 id="DDPG（Deep-Deterministic-Policy-Gradient）"><a href="#DDPG（Deep-Deterministic-Policy-Gradient）" class="headerlink" title="DDPG（Deep Deterministic Policy Gradient）"></a>DDPG（Deep Deterministic Policy Gradient）</h3><p>DDPG借鉴了DQN的技巧，也就是目标网络和经验回放。并且可以输出确定的动作（即动作的幅度），并且是一个单步更新的Policy网络。</p>
<h4 id="Actor-Critic"><a href="#Actor-Critic" class="headerlink" title="Actor-Critic"></a>Actor-Critic</h4><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/48.png" class>

<p>我们有两个神经网络，一个Actor，一个Critic。Actor的任务是对外输出动作并且根据Critic的打分来调整自己的参数来获得更好的输出，使得Critic打分更高。</p>
<p>Critic的任务是对Actor的输出做评估（预测），并且通过reward不断调整自己的预测能可能地接近reward。这也就是一个Q网络。</p>
<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/49.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/50.png" class>

<p>实际上，为了更新的稳定，我们又分别给Actor和Critic都附加一个Target网络，和DQN一样，也就是说DDPG存在四个网络。</p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/51.png" class>

<p>分类数据的reply_memory.py：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> random
<span class="token keyword">import</span> collections
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np


<span class="token keyword">class</span> <span class="token class-name">ReplayMemory</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>buffer <span class="token operator">=</span> collections<span class="token punctuation">.</span>deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span>max_size<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">append</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>exp<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        mini_batch <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>self<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> batch_size<span class="token punctuation">)</span>
        obs_batch<span class="token punctuation">,</span> action_batch<span class="token punctuation">,</span> reward_batch<span class="token punctuation">,</span> next_obs_batch<span class="token punctuation">,</span> done_batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> experience <span class="token keyword">in</span> mini_batch<span class="token punctuation">:</span>
            s<span class="token punctuation">,</span> a<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s_p<span class="token punctuation">,</span> done <span class="token operator">=</span> experience
            obs_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
            action_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
            reward_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            next_obs_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>s_p<span class="token punctuation">)</span>
            done_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>done<span class="token punctuation">)</span>

        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>obs_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> \
            np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>action_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>reward_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\
            np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>next_obs_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>done_batch<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span></code></pre>
<p>model.py：</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl <span class="token keyword">import</span> layers

<span class="token comment" spellcheck="true"># 用一个类把两个模型封装起来</span>
<span class="token keyword">class</span> <span class="token class-name">Model</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> act_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>actor_model <span class="token operator">=</span> ActorModel<span class="token punctuation">(</span>act_dim<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>critic_model <span class="token operator">=</span> CriticModel<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">policy</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>actor_model<span class="token punctuation">.</span>policy<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">value</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> act<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>critic_model<span class="token punctuation">.</span>value<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> act<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 获取actor网络的parameters的名称，返回包含模型所有参数名称的list</span>
    <span class="token keyword">def</span> <span class="token function">get_actor_params</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>actor_model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># Actor网络</span>
<span class="token keyword">class</span> <span class="token class-name">ActorModel</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> act_dim<span class="token punctuation">)</span><span class="token punctuation">:</span>
        hid_size <span class="token operator">=</span> <span class="token number">100</span>

        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> layers<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>size<span class="token operator">=</span>hid_size<span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> layers<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>size<span class="token operator">=</span>act_dim<span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'tanh'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">policy</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        hid <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        means <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>hid<span class="token punctuation">)</span>
        <span class="token keyword">return</span> means

<span class="token comment" spellcheck="true"># Critic网络</span>
<span class="token keyword">class</span> <span class="token class-name">CriticModel</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        hid_size <span class="token operator">=</span> <span class="token number">100</span>

        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> layers<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>size<span class="token operator">=</span>hid_size<span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> layers<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span>None<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">value</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> act<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 拼接两个数组</span>
        concat <span class="token operator">=</span> layers<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>obs<span class="token punctuation">,</span> act<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        hid <span class="token operator">=</span> self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>concat<span class="token punctuation">)</span>
        Q <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>hid<span class="token punctuation">)</span>
        Q <span class="token operator">=</span> layers<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>Q<span class="token punctuation">,</span> axes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> Q
</code></pre>
<p>最关键的algorithm.py：</p>
<p>其实两个Target model都是给Critic更新参数用的，而Actor更新参数只需要看Critic的输出。</p>
<pre class=" language-python"><code class="language-python">
<span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl <span class="token keyword">import</span> layers
<span class="token keyword">from</span> copy <span class="token keyword">import</span> deepcopy
<span class="token keyword">from</span> paddle <span class="token keyword">import</span> fluid


<span class="token keyword">class</span> <span class="token class-name">DDPG</span><span class="token punctuation">(</span>parl<span class="token punctuation">.</span>Algorithm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>model<span class="token punctuation">,</span>gamma<span class="token operator">=</span>None<span class="token punctuation">,</span>tau<span class="token operator">=</span>None<span class="token punctuation">,</span>actor_lr<span class="token operator">=</span>None<span class="token punctuation">,</span>critic_lr<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""  DDPG algorithm      
        Args:
            model (parl.Model): actor and critic 的前向网络.
                                model 必须实现 get_actor_params() 方法.
            gamma (float): reward的衰减因子.
            tau (float): self.target_model 跟 self.model 同步参数 的 软更新参数
            actor_lr (float): actor 的学习率
            critic_lr (float): critic 的学习率
        """</span>
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>gamma<span class="token punctuation">,</span> float<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>tau<span class="token punctuation">,</span> float<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>actor_lr<span class="token punctuation">,</span> float<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> isinstance<span class="token punctuation">(</span>critic_lr<span class="token punctuation">,</span> float<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>gamma <span class="token operator">=</span> gamma
        self<span class="token punctuation">.</span>tau <span class="token operator">=</span> tau
        self<span class="token punctuation">.</span>actor_lr <span class="token operator">=</span> actor_lr
        self<span class="token punctuation">.</span>critic_lr <span class="token operator">=</span> critic_lr
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        self<span class="token punctuation">.</span>target_model <span class="token operator">=</span> deepcopy<span class="token punctuation">(</span>model<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 使用 self.model 的 actor model 来预测动作
        """</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>policy<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> terminal<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" 用DDPG算法更新 actor 和 critic
        """</span>
        actor_cost <span class="token operator">=</span> self<span class="token punctuation">.</span>_actor_learn<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        critic_cost <span class="token operator">=</span> self<span class="token punctuation">.</span>_critic_learn<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span>
                                         terminal<span class="token punctuation">)</span>
        <span class="token keyword">return</span> actor_cost<span class="token punctuation">,</span> critic_cost

    <span class="token keyword">def</span> <span class="token function">_actor_learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 计算Critic中的Q，然后使这个Q越大越好</span>
        action <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>policy<span class="token punctuation">(</span>obs<span class="token punctuation">)</span>
        Q <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>value<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        cost <span class="token operator">=</span> layers<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1.0</span> <span class="token operator">*</span> Q<span class="token punctuation">)</span>
        optimizer <span class="token operator">=</span> fluid<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>actor_lr<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># 只更新Actor的参数，因此要给minimize指定目标，否则也会调整到Critic的参数</span>
        optimizer<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>cost<span class="token punctuation">,</span> parameter_list<span class="token operator">=</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>get_actor_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> cost

    <span class="token keyword">def</span> <span class="token function">_critic_learn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> terminal<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 计算Target Q，也就是目标价值</span>
        next_action <span class="token operator">=</span> self<span class="token punctuation">.</span>target_model<span class="token punctuation">.</span>policy<span class="token punctuation">(</span>next_obs<span class="token punctuation">)</span>
        next_Q <span class="token operator">=</span> self<span class="token punctuation">.</span>target_model<span class="token punctuation">.</span>value<span class="token punctuation">(</span>next_obs<span class="token punctuation">,</span> next_action<span class="token punctuation">)</span>
        terminal <span class="token operator">=</span> layers<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>terminal<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
        target_Q <span class="token operator">=</span> reward <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> terminal<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>gamma <span class="token operator">*</span> next_Q
        target_Q<span class="token punctuation">.</span>stop_gradient <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token comment" spellcheck="true"># 根据网络得出现在的Q，然后算出均方差，用来训练网络使得Q趋近于Target Q</span>
        Q <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>value<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
        cost <span class="token operator">=</span> layers<span class="token punctuation">.</span>square_error_cost<span class="token punctuation">(</span>Q<span class="token punctuation">,</span> target_Q<span class="token punctuation">)</span>
        cost <span class="token operator">=</span> layers<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>
        optimizer <span class="token operator">=</span> fluid<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>AdamOptimizer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>critic_lr<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>cost<span class="token punctuation">)</span>
        <span class="token keyword">return</span> cost

    <span class="token keyword">def</span> <span class="token function">sync_target</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> decay<span class="token operator">=</span>None<span class="token punctuation">,</span> share_vars_parallel_executor<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" self.target_model从self.model复制参数过来，若decay不为None,则是软更新
        """</span>
        <span class="token keyword">if</span> decay <span class="token keyword">is</span> None<span class="token punctuation">:</span>
            decay <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>tau
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>sync_weights_to<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>target_model<span class="token punctuation">,</span>
            decay<span class="token operator">=</span>decay<span class="token punctuation">,</span>
            share_vars_parallel_executor<span class="token operator">=</span>share_vars_parallel_executor<span class="token punctuation">)</span>
</code></pre>
<p>train.py：</p>
<pre class=" language-python"><code class="language-python">
<span class="token keyword">import</span> gym
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> parl
<span class="token keyword">from</span> parl<span class="token punctuation">.</span>utils <span class="token keyword">import</span> logger

<span class="token keyword">from</span> agent <span class="token keyword">import</span> Agent
<span class="token keyword">from</span> model <span class="token keyword">import</span> Model
<span class="token keyword">from</span> algorithm <span class="token keyword">import</span> DDPG  <span class="token comment" spellcheck="true"># from parl.algorithms import DDPG</span>
<span class="token keyword">from</span> env <span class="token keyword">import</span> ContinuousCartPoleEnv
<span class="token keyword">from</span> replay_memory <span class="token keyword">import</span> ReplayMemory

ACTOR_LR <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span>  <span class="token comment" spellcheck="true"># Actor网络的 learning rate</span>
CRITIC_LR <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span>  <span class="token comment" spellcheck="true"># Critic网络的 learning rate</span>
GAMMA <span class="token operator">=</span> <span class="token number">0.99</span>  <span class="token comment" spellcheck="true"># reward 的衰减因子</span>
TAU <span class="token operator">=</span> <span class="token number">0.001</span>  <span class="token comment" spellcheck="true"># 软更新的系数</span>
MEMORY_SIZE <span class="token operator">=</span> int<span class="token punctuation">(</span><span class="token number">1e6</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 经验池大小</span>
MEMORY_WARMUP_SIZE <span class="token operator">=</span> MEMORY_SIZE <span class="token operator">//</span> <span class="token number">20</span>  <span class="token comment" spellcheck="true"># 预存一部分经验之后再开始训练</span>
BATCH_SIZE <span class="token operator">=</span> <span class="token number">128</span>
REWARD_SCALE <span class="token operator">=</span> <span class="token number">0.1</span>  <span class="token comment" spellcheck="true"># reward 缩放系数</span>
NOISE <span class="token operator">=</span> <span class="token number">0.05</span>  <span class="token comment" spellcheck="true"># 动作噪声方差</span>
TRAIN_EPISODE <span class="token operator">=</span> <span class="token number">6e3</span>  <span class="token comment" spellcheck="true"># 训练的总episode数</span>


<span class="token comment" spellcheck="true"># 训练一个episode</span>
<span class="token keyword">def</span> <span class="token function">run_episode</span><span class="token punctuation">(</span>agent<span class="token punctuation">,</span> env<span class="token punctuation">,</span> rpm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    total_reward <span class="token operator">=</span> <span class="token number">0</span>
    steps <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        steps <span class="token operator">+=</span> <span class="token number">1</span>
        batch_obs <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        action <span class="token operator">=</span> agent<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>batch_obs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># 增加探索扰动, 输出限制在 [-1.0, 1.0] 范围内</span>
        action <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>normal<span class="token punctuation">(</span>action<span class="token punctuation">,</span> NOISE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>

        next_obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

        action <span class="token operator">=</span> <span class="token punctuation">[</span>action<span class="token punctuation">]</span>  <span class="token comment" spellcheck="true"># 方便存入replaymemory</span>
        rpm<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>obs<span class="token punctuation">,</span> action<span class="token punctuation">,</span> REWARD_SCALE <span class="token operator">*</span> reward<span class="token punctuation">,</span> next_obs<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true"># 预存多个经验以及每五个step提取一次</span>
        <span class="token keyword">if</span> len<span class="token punctuation">(</span>rpm<span class="token punctuation">)</span> <span class="token operator">></span> MEMORY_WARMUP_SIZE <span class="token operator">and</span> <span class="token punctuation">(</span>steps <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token punctuation">(</span>batch_obs<span class="token punctuation">,</span> batch_action<span class="token punctuation">,</span> batch_reward<span class="token punctuation">,</span> batch_next_obs<span class="token punctuation">,</span>
             batch_done<span class="token punctuation">)</span> <span class="token operator">=</span> rpm<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>BATCH_SIZE<span class="token punctuation">)</span>
            agent<span class="token punctuation">.</span>learn<span class="token punctuation">(</span>batch_obs<span class="token punctuation">,</span> batch_action<span class="token punctuation">,</span> batch_reward<span class="token punctuation">,</span> batch_next_obs<span class="token punctuation">,</span>
                        batch_done<span class="token punctuation">)</span>

        obs <span class="token operator">=</span> next_obs
        total_reward <span class="token operator">+=</span> reward

        <span class="token keyword">if</span> done <span class="token operator">or</span> steps <span class="token operator">>=</span> <span class="token number">200</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> total_reward


<span class="token comment" spellcheck="true"># 评估 agent, 跑 5 个episode，总reward求平均</span>
<span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    eval_reward <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        obs <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
        total_reward <span class="token operator">=</span> <span class="token number">0</span>
        steps <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            batch_obs <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>obs<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            action <span class="token operator">=</span> agent<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>batch_obs<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            action <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>

            steps <span class="token operator">+=</span> <span class="token number">1</span>
            next_obs<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

            obs <span class="token operator">=</span> next_obs
            total_reward <span class="token operator">+=</span> reward

            <span class="token keyword">if</span> render<span class="token punctuation">:</span>
                env<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> done <span class="token operator">or</span> steps <span class="token operator">>=</span> <span class="token number">200</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        eval_reward<span class="token punctuation">.</span>append<span class="token punctuation">(</span>total_reward<span class="token punctuation">)</span>
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>eval_reward<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    env <span class="token operator">=</span> ContinuousCartPoleEnv<span class="token punctuation">(</span><span class="token punctuation">)</span>

    obs_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>observation_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    act_dim <span class="token operator">=</span> env<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true"># 使用PARL框架创建agent</span>
    model <span class="token operator">=</span> Model<span class="token punctuation">(</span>act_dim<span class="token punctuation">)</span>
    algorithm <span class="token operator">=</span> DDPG<span class="token punctuation">(</span>
        model<span class="token punctuation">,</span> gamma<span class="token operator">=</span>GAMMA<span class="token punctuation">,</span> tau<span class="token operator">=</span>TAU<span class="token punctuation">,</span> actor_lr<span class="token operator">=</span>ACTOR_LR<span class="token punctuation">,</span> critic_lr<span class="token operator">=</span>CRITIC_LR<span class="token punctuation">)</span>
    agent <span class="token operator">=</span> Agent<span class="token punctuation">(</span>algorithm<span class="token punctuation">,</span> obs_dim<span class="token punctuation">,</span> act_dim<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 创建经验池</span>
    rpm <span class="token operator">=</span> ReplayMemory<span class="token punctuation">(</span>MEMORY_SIZE<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 往经验池中预存数据</span>
    <span class="token keyword">while</span> len<span class="token punctuation">(</span>rpm<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MEMORY_WARMUP_SIZE<span class="token punctuation">:</span>
        run_episode<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> env<span class="token punctuation">,</span> rpm<span class="token punctuation">)</span>

    episode <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> episode <span class="token operator">&lt;</span> TRAIN_EPISODE<span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            total_reward <span class="token operator">=</span> run_episode<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> env<span class="token punctuation">,</span> rpm<span class="token punctuation">)</span>
            episode <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token comment" spellcheck="true"># 每50个episode评估一次</span>
        eval_reward <span class="token operator">=</span> evaluate<span class="token punctuation">(</span>env<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> render<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'episode:{}    Test reward:{}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>
            episode<span class="token punctuation">,</span> eval_reward<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>另外附上环境的代码env.py：</p>
<pre class=" language-python"><code class="language-python">
<span class="token triple-quoted-string string">"""
Classic cart-pole system implemented by Rich Sutton et al.
Copied from http://incompleteideas.net/sutton/book/code/pole.c
permalink: https://perma.cc/C9ZM-652R

Continuous version by Ian Danforth
"""</span>

<span class="token keyword">import</span> math
<span class="token keyword">import</span> gym
<span class="token keyword">from</span> gym <span class="token keyword">import</span> spaces<span class="token punctuation">,</span> logger
<span class="token keyword">from</span> gym<span class="token punctuation">.</span>utils <span class="token keyword">import</span> seeding
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np


<span class="token keyword">class</span> <span class="token class-name">ContinuousCartPoleEnv</span><span class="token punctuation">(</span>gym<span class="token punctuation">.</span>Env<span class="token punctuation">)</span><span class="token punctuation">:</span>
    metadata <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'render.modes'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'human'</span><span class="token punctuation">,</span> <span class="token string">'rgb_array'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'video.frames_per_second'</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>gravity <span class="token operator">=</span> <span class="token number">9.8</span>
        self<span class="token punctuation">.</span>masscart <span class="token operator">=</span> <span class="token number">1.0</span>
        self<span class="token punctuation">.</span>masspole <span class="token operator">=</span> <span class="token number">0.1</span>
        self<span class="token punctuation">.</span>total_mass <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>masspole <span class="token operator">+</span> self<span class="token punctuation">.</span>masscart<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0.5</span>  <span class="token comment" spellcheck="true"># actually half the pole's length</span>
        self<span class="token punctuation">.</span>polemass_length <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>masspole <span class="token operator">*</span> self<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>force_mag <span class="token operator">=</span> <span class="token number">30.0</span>
        self<span class="token punctuation">.</span>tau <span class="token operator">=</span> <span class="token number">0.02</span>  <span class="token comment" spellcheck="true"># seconds between state updates</span>
        self<span class="token punctuation">.</span>min_action <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span>
        self<span class="token punctuation">.</span>max_action <span class="token operator">=</span> <span class="token number">1.0</span>

        <span class="token comment" spellcheck="true"># Angle at which to fail the episode</span>
        self<span class="token punctuation">.</span>theta_threshold_radians <span class="token operator">=</span> <span class="token number">12</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>pi <span class="token operator">/</span> <span class="token number">360</span>
        self<span class="token punctuation">.</span>x_threshold <span class="token operator">=</span> <span class="token number">2.4</span>

        <span class="token comment" spellcheck="true"># Angle limit set to 2 * theta_threshold_radians so failing observation</span>
        <span class="token comment" spellcheck="true"># is still within bounds</span>
        high <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>
            self<span class="token punctuation">.</span>x_threshold <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
            np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>max<span class="token punctuation">,</span> self<span class="token punctuation">.</span>theta_threshold_radians <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span>
            np<span class="token punctuation">.</span>finfo<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span><span class="token punctuation">.</span>max
        <span class="token punctuation">]</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>action_space <span class="token operator">=</span> spaces<span class="token punctuation">.</span>Box<span class="token punctuation">(</span>
            low<span class="token operator">=</span>self<span class="token punctuation">.</span>min_action<span class="token punctuation">,</span> high<span class="token operator">=</span>self<span class="token punctuation">.</span>max_action<span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>observation_space <span class="token operator">=</span> spaces<span class="token punctuation">.</span>Box<span class="token punctuation">(</span><span class="token operator">-</span>high<span class="token punctuation">,</span> high<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>viewer <span class="token operator">=</span> None
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> None

        self<span class="token punctuation">.</span>steps_beyond_done <span class="token operator">=</span> None

    <span class="token keyword">def</span> <span class="token function">seed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> seed<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>np_random<span class="token punctuation">,</span> seed <span class="token operator">=</span> seeding<span class="token punctuation">.</span>np_random<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>seed<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">stepPhysics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> force<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x<span class="token punctuation">,</span> x_dot<span class="token punctuation">,</span> theta<span class="token punctuation">,</span> theta_dot <span class="token operator">=</span> self<span class="token punctuation">.</span>state
        costheta <span class="token operator">=</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>theta<span class="token punctuation">)</span>
        sintheta <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>theta<span class="token punctuation">)</span>
        temp <span class="token operator">=</span> <span class="token punctuation">(</span>force <span class="token operator">+</span> self<span class="token punctuation">.</span>polemass_length <span class="token operator">*</span> theta_dot <span class="token operator">*</span> theta_dot <span class="token operator">*</span> sintheta
                <span class="token punctuation">)</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>total_mass
        thetaacc <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>gravity <span class="token operator">*</span> sintheta <span class="token operator">-</span> costheta <span class="token operator">*</span> temp<span class="token punctuation">)</span> <span class="token operator">/</span> \
            <span class="token punctuation">(</span>self<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">4.0</span><span class="token operator">/</span><span class="token number">3.0</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>masspole <span class="token operator">*</span> costheta <span class="token operator">*</span> costheta <span class="token operator">/</span> self<span class="token punctuation">.</span>total_mass<span class="token punctuation">)</span><span class="token punctuation">)</span>
        xacc <span class="token operator">=</span> temp <span class="token operator">-</span> self<span class="token punctuation">.</span>polemass_length <span class="token operator">*</span> thetaacc <span class="token operator">*</span> costheta <span class="token operator">/</span> self<span class="token punctuation">.</span>total_mass
        x <span class="token operator">=</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>tau <span class="token operator">*</span> x_dot
        x_dot <span class="token operator">=</span> x_dot <span class="token operator">+</span> self<span class="token punctuation">.</span>tau <span class="token operator">*</span> xacc
        theta <span class="token operator">=</span> theta <span class="token operator">+</span> self<span class="token punctuation">.</span>tau <span class="token operator">*</span> theta_dot
        theta_dot <span class="token operator">=</span> theta_dot <span class="token operator">+</span> self<span class="token punctuation">.</span>tau <span class="token operator">*</span> thetaacc
        <span class="token keyword">return</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> x_dot<span class="token punctuation">,</span> theta<span class="token punctuation">,</span> theta_dot<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span>
        action <span class="token operator">=</span> np<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> self<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">,</span> \
            <span class="token string">"%r (%s) invalid"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>action<span class="token punctuation">,</span> type<span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true"># Cast action to float to strip np trappings</span>
        force <span class="token operator">=</span> self<span class="token punctuation">.</span>force_mag <span class="token operator">*</span> float<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> self<span class="token punctuation">.</span>stepPhysics<span class="token punctuation">(</span>force<span class="token punctuation">)</span>
        x<span class="token punctuation">,</span> x_dot<span class="token punctuation">,</span> theta<span class="token punctuation">,</span> theta_dot <span class="token operator">=</span> self<span class="token punctuation">.</span>state
        done <span class="token operator">=</span> x <span class="token operator">&lt;</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>x_threshold \
            <span class="token operator">or</span> x <span class="token operator">></span> self<span class="token punctuation">.</span>x_threshold \
            <span class="token operator">or</span> theta <span class="token operator">&lt;</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>theta_threshold_radians \
            <span class="token operator">or</span> theta <span class="token operator">></span> self<span class="token punctuation">.</span>theta_threshold_radians
        done <span class="token operator">=</span> bool<span class="token punctuation">(</span>done<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token operator">not</span> done<span class="token punctuation">:</span>
            reward <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>steps_beyond_done <span class="token keyword">is</span> None<span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Pole just fell!</span>
            self<span class="token punctuation">.</span>steps_beyond_done <span class="token operator">=</span> <span class="token number">0</span>
            reward <span class="token operator">=</span> <span class="token number">1.0</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>steps_beyond_done <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
You are calling 'step()' even though this environment has already returned
done = True. You should always call 'reset()' once you receive 'done = True'
Any further steps are undefined behavior.
                """</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>steps_beyond_done <span class="token operator">+=</span> <span class="token number">1</span>
            reward <span class="token operator">=</span> <span class="token number">0.0</span>

        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> self<span class="token punctuation">.</span>np_random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span>low<span class="token operator">=</span><span class="token operator">-</span><span class="token number">0.05</span><span class="token punctuation">,</span> high<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>steps_beyond_done <span class="token operator">=</span> None
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'human'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        screen_width <span class="token operator">=</span> <span class="token number">600</span>
        screen_height <span class="token operator">=</span> <span class="token number">400</span>

        world_width <span class="token operator">=</span> self<span class="token punctuation">.</span>x_threshold <span class="token operator">*</span> <span class="token number">2</span>
        scale <span class="token operator">=</span> screen_width <span class="token operator">/</span> world_width
        carty <span class="token operator">=</span> <span class="token number">100</span>  <span class="token comment" spellcheck="true"># TOP OF CART</span>
        polewidth <span class="token operator">=</span> <span class="token number">10.0</span>
        polelen <span class="token operator">=</span> scale <span class="token operator">*</span> <span class="token number">1.0</span>
        cartwidth <span class="token operator">=</span> <span class="token number">50.0</span>
        cartheight <span class="token operator">=</span> <span class="token number">30.0</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>viewer <span class="token keyword">is</span> None<span class="token punctuation">:</span>
            <span class="token keyword">from</span> gym<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>classic_control <span class="token keyword">import</span> rendering
            self<span class="token punctuation">.</span>viewer <span class="token operator">=</span> rendering<span class="token punctuation">.</span>Viewer<span class="token punctuation">(</span>screen_width<span class="token punctuation">,</span> screen_height<span class="token punctuation">)</span>
            l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> t<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token operator">-</span>cartwidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> cartwidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> cartheight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span>cartheight <span class="token operator">/</span> <span class="token number">2</span>
            axleoffset <span class="token operator">=</span> cartheight <span class="token operator">/</span> <span class="token number">4.0</span>
            cart <span class="token operator">=</span> rendering<span class="token punctuation">.</span>FilledPolygon<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>r<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>r<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>carttrans <span class="token operator">=</span> rendering<span class="token punctuation">.</span>Transform<span class="token punctuation">(</span><span class="token punctuation">)</span>
            cart<span class="token punctuation">.</span>add_attr<span class="token punctuation">(</span>self<span class="token punctuation">.</span>carttrans<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>viewer<span class="token punctuation">.</span>add_geom<span class="token punctuation">(</span>cart<span class="token punctuation">)</span>
            l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> t<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token operator">-</span>polewidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> polewidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> polelen <span class="token operator">-</span> polewidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span>polewidth <span class="token operator">/</span> <span class="token number">2</span>
            pole <span class="token operator">=</span> rendering<span class="token punctuation">.</span>FilledPolygon<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>l<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>r<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>r<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            pole<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token number">4</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>poletrans <span class="token operator">=</span> rendering<span class="token punctuation">.</span>Transform<span class="token punctuation">(</span>translation<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> axleoffset<span class="token punctuation">)</span><span class="token punctuation">)</span>
            pole<span class="token punctuation">.</span>add_attr<span class="token punctuation">(</span>self<span class="token punctuation">.</span>poletrans<span class="token punctuation">)</span>
            pole<span class="token punctuation">.</span>add_attr<span class="token punctuation">(</span>self<span class="token punctuation">.</span>carttrans<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>viewer<span class="token punctuation">.</span>add_geom<span class="token punctuation">(</span>pole<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>axle <span class="token operator">=</span> rendering<span class="token punctuation">.</span>make_circle<span class="token punctuation">(</span>polewidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>axle<span class="token punctuation">.</span>add_attr<span class="token punctuation">(</span>self<span class="token punctuation">.</span>poletrans<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>axle<span class="token punctuation">.</span>add_attr<span class="token punctuation">(</span>self<span class="token punctuation">.</span>carttrans<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>axle<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token number">8</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>viewer<span class="token punctuation">.</span>add_geom<span class="token punctuation">(</span>self<span class="token punctuation">.</span>axle<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>track <span class="token operator">=</span> rendering<span class="token punctuation">.</span>Line<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> carty<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>screen_width<span class="token punctuation">,</span> carty<span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>track<span class="token punctuation">.</span>set_color<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>viewer<span class="token punctuation">.</span>add_geom<span class="token punctuation">(</span>self<span class="token punctuation">.</span>track<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>state <span class="token keyword">is</span> None<span class="token punctuation">:</span>
            <span class="token keyword">return</span> None

        x <span class="token operator">=</span> self<span class="token punctuation">.</span>state
        cartx <span class="token operator">=</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> scale <span class="token operator">+</span> screen_width <span class="token operator">/</span> <span class="token number">2.0</span>  <span class="token comment" spellcheck="true"># MIDDLE OF CART</span>
        self<span class="token punctuation">.</span>carttrans<span class="token punctuation">.</span>set_translation<span class="token punctuation">(</span>cartx<span class="token punctuation">,</span> carty<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>poletrans<span class="token punctuation">.</span>set_rotation<span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> self<span class="token punctuation">.</span>viewer<span class="token punctuation">.</span>render<span class="token punctuation">(</span>return_rgb_array<span class="token operator">=</span><span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token string">'rgb_array'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>viewer<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>viewer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="拓展-1"><a href="#拓展-1" class="headerlink" title="拓展"></a>拓展</h2><h3 id="RLSchool：一个强化学习模拟环境合集"><a href="#RLSchool：一个强化学习模拟环境合集" class="headerlink" title="RLSchool：一个强化学习模拟环境合集"></a>RLSchool：一个强化学习模拟环境合集</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/52.png" class>



<h3 id="无人机悬浮控制任务"><a href="#无人机悬浮控制任务" class="headerlink" title="无人机悬浮控制任务"></a>无人机悬浮控制任务</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/53.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/54.png" class>





<h3 id="更多环境"><a href="#更多环境" class="headerlink" title="更多环境"></a>更多环境</h3><img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/55.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/56.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/57.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/58.png" class>

<img src="/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/59.png" class>

<p>1星环境：简单的弹跳和接球游戏：<a target="_blank" rel="noopener" href="https://github.com/shivaverma/Orbit">https://github.com/shivaverma/Orbit</a><br>2星环境：GYM环境  Box2D (需要安装 box2d-py)：<a target="_blank" rel="noopener" href="https://gym.openai.com/envs/#box2d">https://gym.openai.com/envs/#box2d</a><br>PyGame游戏环境（含Flappy Bird）：<a target="_blank" rel="noopener" href="https://github.com/ntasfi/PyGame-Learning-Environment">https://github.com/ntasfi/PyGame-Learning-Environment</a><br>3星环境：GYM环境  Robotics (需要安装 mujoco_py和试用许可证书)：<a target="_blank" rel="noopener" href="https://gym.openai.com/envs/#robotics">https://gym.openai.com/envs/#robotics</a><br>股票预测环境：<a target="_blank" rel="noopener" href="https://github.com/kh-kim/stock_market_reinforcement_learning">https://github.com/kh-kim/stock_market_reinforcement_learning</a><br>RLSchool四轴飞行器的 速度控制任务 “velocity_control”：<a target="_blank" rel="noopener" href="https://github.com/PaddlePaddle/RLSchool/tree/master/rlschool/quadrotor">https://github.com/PaddlePaddle/RLSchool/tree/master/rlschool/quadrotor</a><br>4星环境：RLBench任务环境（使用机械臂完成某一项任务）：<a target="_blank" rel="noopener" href="https://github.com/stepjam/RLBench">https://github.com/stepjam/RLBench</a><br>5星环境：交通信号灯控制：<a target="_blank" rel="noopener" href="https://github.com/Ujwal2910/Smart-Traffic-Signals-in-India-using-Deep-Reinforcement-Learning-and-Advanced-Computer-Vision">https://github.com/Ujwal2910/Smart-Traffic-Signals-in-India-using-Deep-Reinforcement-Learning-and-Advanced-Computer-Vision</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">微笑紫瞳星</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://tianjuewudi.gitee.io/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/">https://tianjuewudi.gitee.io/2021/07/16/qiang-hua-xue-xi-shi-jian-jiao-xue/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">微笑紫瞳星</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">
                                    <span class="chip bg-color">强化学习</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'bpzS5Q9Q9zMl4doyyDGqIqqq-gzGzoHsz',
        appKey: 'M0IfLJW2G1dCMyLTb90tFxT8',
        notify: 'true' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '请畅所欲言'
    });
</script>

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/07/21/qiang-hua-xue-xi-gang-yao-zhou-bo-lei-ke-cheng/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="强化学习纲要（周博磊课程）">
                        
                        <span class="card-title">强化学习纲要（周博磊课程）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-21
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/" class="post-category">
                                    强化学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0/">
                        <span class="chip bg-color">强化学习</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/15/yuan-xue-xi-meta-learning/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="元学习（Meta Learning）">
                        
                        <span class="card-title">元学习（Meta Learning）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-15
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" class="post-category">
                                    机器学习
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/">
                        <span class="chip bg-color">机器学习</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('50')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 微笑紫瞳星<br />'
            + '文章作者: 微笑紫瞳星<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处，谢谢啦~';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>



    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="tencent"
                   type="playlist"
                   id="8075110837"
                   fixed='true'
                   autoplay='true'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.35'
                   list-folded='false'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">微笑紫瞳星</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">143.3k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "1";
                    var startDate = "9";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "11";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">








    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1121452406" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1121452406" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":200,"height":400},"mobile":{"show":false},"log":false});</script></body>

</html>
